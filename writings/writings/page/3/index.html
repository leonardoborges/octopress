
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>Leonardo Borges</title>
	<meta name="author" content="Leonardo Borges">

	
	<meta name="description" content="Keeping the tradition of end-of-year blog posts, here are my year highlights for 2012: Clojure I started clj-syd - the Sydney Clojure User Group - &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="http://feeds.feedburner.com/leonardoborges" rel="alternate" title="Leonardo Borges" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/writings/favicon.png" rel="shortcut icon">
	<link href="/writings/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	
</head>

<body>
	<header id="header" class="inner"><h1><a href="/writings/">Leonardo Borges</a></h1>
<nav id="main-nav"><ul class="main-navigation">
  <li><a href="/writings/">Blog</a></li>
  <li><a href="/writings/about">About</a></li>
  <li><a href="/writings/projects">Projects</a></li>
  <li><a href="/writings/presentations">Talks</a></li>
  <li><a href="/writings/books">Books</a></li>
  <li><a href="/writings/archives">Archives</a></li>
</ul>
</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul class="main-navigation">
  <li><a href="/writings/">Blog</a></li>
  <li><a href="/writings/about">About</a></li>
  <li><a href="/writings/projects">Projects</a></li>
  <li><a href="/writings/presentations">Talks</a></li>
  <li><a href="/writings/books">Books</a></li>
  <li><a href="/writings/archives">Archives</a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="http://google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:www.leonardoborges.com/writings">
			</form>
		</div>
	</div>
</nav>
<nav id="sub-nav" class="alignright">
	<div class="social">
		
		
		
		<a class="twitter" href="http://twitter.com/leonardo_borges" title="Twitter">Twitter</a>
		
		
		<a class="github" href="https://github.com/leonardoborges" title="GitHub">GitHub</a>
		
		
		
		
		
		<a class="rss" href="http://feeds.feedburner.com/leonardoborges" title="RSS">RSS</a>
		
	</div>
	<form class="search" action="http://google.com/search" method="get">
		<input class="alignright" type="text" name="q" results="0">
		<input type="hidden" name="q" value="site:www.leonardoborges.com/writings">
	</form>
</nav>

</header>
	
		
<!-- <div id="banner" class="inner"> -->
<!--     <div class="container"> -->
<!--         <ul class="feed"></ul> -->
<!--     </div> -->
<!--     <small><a href="http://twitter.com/leonardo_borges">leonardo_borges</a> @ <a href="http://twitter.com">Twitter</a></small> -->
<!--     <div class="loading">Loading...</div> -->
<!-- </div> -->
<!-- <script src="/writings/javascripts/twitter.js"></script> -->
<!-- <script type="text/javascript"> -->
<!--     (function($){ -->
<!--         $('#banner').getTwitterFeed('leonardo_borges', 4, false); -->
<!--     })(jQuery); -->
<!-- </script> -->


	
	<div id="content" class="inner">


    <article class="post">
	<h1 class="title"><a href="/writings/2013/01/02/so-long-2012-year-highlights/">So Long 2012: Year Highlights</a></h1>
	<div class="entry-content">
		<p>Keeping the tradition of end-of-year blog posts, here are my year highlights for 2012:</p>

<h2>Clojure</h2>

<p>I started <a href="http://www.meetup.com/clj-syd/">clj-syd</a> - the Sydney Clojure User Group - back in January and it has seen a major uptake. We consistently get an average of 25 people each month and there&#8217;s no shortage of talks and topics to discuss. It&#8217;s a great crowd and I&#8217;m proud to have started it and of being part of it.</p>

<h2>Speaking</h2>

<p>I spent most of the year studying functional programming and I tried to make my talks reflect that. Even the javascript talk I gave in April had a FP focus. Anyway, you can find some of the slides online:</p>

<ul>
<li><p><a href="http://www.slideshare.net/borgesleonardo/the-many-facets-of-code-reuse-in-javascript">The many facets of code reuse in JavaScript</a> - this was given at a ThoughtWorks technical event in April</p></li>
<li><p><a href="http://www.slideshare.net/borgesleonardo/continuation-passing-style-and-macros-in-clojure-jan-2012">Continuation Passing Style and Macros in Clojure</a> - this is the talk I gave at our first Clojure meetup in Sydney</p></li>
<li><p><a href="http://www.slideshare.net/borgesleonardo/clojure-reducers-cljsyd-aug-2012">Clojure Reducers</a> - Another preso I gave at the clojure user group, in August.</p></li>
</ul>


<h2>Books</h2>

<p>As usual I read a number of books this year and these are my favourites:</p>

<ul>
<li>The Little Schemer</li>
</ul>


<iframe src="http://rcm.amazon.com/e/cm?lt1=_blank&bc1=FFFFFF&IS2=1&nou=1&bg1=FFFFFF&fc1=000000&lc1=0000FF&t=leonaborge-20&o=1&p=8&l=as1&m=amazon&f=ifr&ref=qf_sp_asin_til&asins=0262560992" style="width:120px;height:240px;" scrolling="no" marginwidth="0" marginheight="0" frameborder="0"></iframe>


<p>As they say, an oldie but a goodie. This is mandatory reading for anyone who consider themselves a serious programmer. The insights and techniques found here are invaluable. Do yourself a favor and buy it now.</p>

<blockquote><p>For a Clojure take on it, check <a href="https://twitter.com/juliansgamble">Julian Gamble</a>&#8217;s series on <a href="http://juliangamble.com/blog/2012/07/20/the-little-schemer-in-clojure-chapter-1/">The Little Schemer in Clojure</a></p></blockquote>

<ul>
<li>The Joy of Clojure</li>
</ul>


<iframe src="http://rcm.amazon.com/e/cm?t=leonaborge-20&o=1&p=8&l=as1&asins=1935182641&nou=1&ref=qf_sp_asin_til&fc1=000000&IS2=1&lt1=_blank&m=amazon&lc1=0000FF&bc1=FFFFFF&bg1=FFFFFF&f=ifr" style="width:120px;height:240px;" scrolling="no" marginwidth="0" marginheight="0" frameborder="0"></iframe>


<p>This is pretty much how I learned Clojure. I actually started reading it in November 2011 but felt I needed to put it down from time to time to go and code on my own to solidify what I learned. That&#8217;s why I only finished it in 2012.</p>

<p>This book packs a great deal of info and is a great way to get into both functional programming and Clojure.</p>

<ul>
<li>Learn you a Haskell for Great Good</li>
</ul>


<iframe src="http://rcm.amazon.com/e/cm?t=leonaborge-20&o=1&p=8&l=as1&asins=1593272839&nou=1&ref=qf_sp_asin_til&fc1=000000&IS2=1&lt1=_blank&m=amazon&lc1=0000FF&bc1=FFFFFF&bg1=FFFFFF&f=ifr" style="width:120px;height:240px;" scrolling="no" marginwidth="0" marginheight="0" frameborder="0"></iframe>


<p>This is the best intro to Haskell ever. Hands down. &#8216;nuff said.</p>

<ul>
<li>Clojure Programming</li>
</ul>


<iframe src="http://rcm.amazon.com/e/cm?t=leonaborge-20&o=1&p=8&l=as1&asins=1449394701&nou=1&ref=qf_sp_asin_til&fc1=000000&IS2=1&lt1=_blank&m=amazon&lc1=0000FF&bc1=FFFFFF&bg1=FFFFFF&f=ifr" style="width:120px;height:240px;" scrolling="no" marginwidth="0" marginheight="0" frameborder="0"></iframe>


<p>I like reading different books about the same subject to get to see it from various perspectives. <em>Clojure Programming</em> takes a different approach to <em>The Joy of Clojure</em> in that, as it progresses through topics and code examples, it contrasts it with languages likely to be familiar to the reader, such as Java, Ruby and Python. Another great alternative if you&#8217;ve been thinking of getting into Clojure but didn&#8217;t know where to start.</p>

<h2>Content</h2>

<p>Here&#8217;s just a few of the posts visitors found most interesting this year:</p>

<ul>
<li><p><a href="http://www.leonardoborges.com/writings/2012/11/30/monads-in-small-bites-part-i-functors/">Monads in Small Bites</a> Parts <a href="http://www.leonardoborges.com/writings/2012/11/30/monads-in-small-bites-part-i-functors/">I</a>, <a href="http://www.leonardoborges.com/writings/2012/12/02/monads-in-small-bites-part-ii-applicative-functors/">II</a>, <a href="http://www.leonardoborges.com/writings/2012/12/05/monads-in-small-bites-part-iii-monoids/">III</a> &amp; <a href="http://www.leonardoborges.com/writings/2012/12/08/monads-in-small-bites-part-iv-monads/">IV</a> - Even though I only published this series in December, it quickly became one of the most read posts that month. And it&#8217;s also a personal favorite.</p></li>
<li><p><a href="http://www.leonardoborges.com/writings/2012/05/03/build-automation-with-xcode-4-dot-3-kif-and-jenkins/">Build Automation With XCode 4.3, KIF and Jenkins</a> - This turned out to be very popular - build automation and testing are not among the top priorities within the iOS community so I&#8217;m glad this helped some people out. It&#8217;s getting way better now.</p></li>
<li><p><a href="http://www.leonardoborges.com/writings/2011/07/30/hiring-good-people-is-really-simple/">Hiring Good People Is Really Simple</a> - Another one high up in my analytics, and it still stands true.</p></li>
<li><p><a href="http://www.leonardoborges.com/writings/2009/07/01/jruby-on-rails-and-legacy-java-apps-managing-dependencies/">JRuby on Rails and Legacy Java Apps: Managing Dependencies</a> - The JRuby enterprise world seems to be hotter than ever before. I wouldn&#8217;t think this post from 2009 would still get this many visits. I haven&#8217;t been involved much with JRuby as of late so I wonder if this is still the way to go?</p></li>
</ul>


<h2>LambdaJam</h2>

<p><a href="http://lambdajam.com/">LambdaJam</a> is a conference for functional programmers and although it&#8217;s set to happen in May 2013 the wheels have already started turning - thus I had to list it as a highlight.</p>

<p>I&#8217;m fortunate enough to be involved with the organization alongside very bright people from the Australian functional programming community as well as Dave Thomas from the <a href="http://www.yowconference.com.au/">YOW! Conference</a> who&#8217;s leading the effort. We&#8217;re all really excited about it.</p>

<p>Stay tuned, lots more info to come!</p>

<h2>Goals</h2>

<p>No resolutions. Goals. And I wanna achieve them. They&#8217;re simple and I hope this post will keep me in check</p>

<h3>Better utilize my free time</h3>

<p>This is a bit abstract but will help me achieve the goals below. The output of this goal is a calendar with time slots assigned to each one of the next goals - I&#8217;ve just done this now actually so this is a good start. No more procrastinating.</p>

<h3>Books</h3>

<p>I got a big pile of books I wanted to have read in 2012 so I&#8217;ll be updating my <a href="goodreads.com/leonardoborges">good reads profile</a> with them and make sure I just do it - with the help of my new calendar from the goal above.</p>

<h3>Side projects</h3>

<p>In 2012 I worked on two side project which are not ready yet, so I can&#8217;t comment a whole lot on them apart from saying that one is being developed in Clojure and the other in Ruby - in 2013, these two will see the light of day.</p>

<h2>Here&#8217;s to a new year</h2>

<p>I hope you all had a great 2012 and are as excited as I am for the new year.</p>

<p>Happy holidays, safe driving and awesome parties! :)</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2013-01-02T13:05:00+11:00" pubdate data-updated="true">Jan 2<span>nd</span>, 2013</time></div>
	<div class="tags">


	<a class='category' href='/writings/tags/misc/'>misc</a>


</div>
	
</div></article>


    <article class="post">
	<h1 class="title"><a href="/writings/2012/12/08/monads-in-small-bites-part-iv-monads/">Monads in Small Bites - Part IV - Monads</a></h1>
	<div class="entry-content">
		<p>This is Part IV of my Monads tutorial. Make sure you read the previous parts:</p>

<ul>
<li><p><a href="/writings/2012/11/30/monads-in-small-bites-part-i-functors/">Part I   - Functors</a></p></li>
<li><p><a href="/writings/2012/12/02/monads-in-small-bites-part-ii-applicative-functors/">Part II  - Applicative Functors</a></p></li>
<li><p><a href="/writings/2012/12/05/monads-in-small-bites-part-iii-monoids/">Part III - Monoids</a></p></li>
<li><p>Part IV  - Monads (this post)</p></li>
</ul>


<h3>A quick recap</h3>

<p>In <a href="/writings/2012/11/30/monads-in-small-bites-part-i-functors/">Part I</a> we learned about <em>Functors</em>, which are things that can be mapped over using a normal function - <code>fmap</code> is used for that.</p>

<p><a href="/writings/2012/12/02/monads-in-small-bites-part-ii-applicative-functors/">Part II</a> tought us that when our Functors themselves contain functions and we want them applied to the values contained in other Functors, <em>Applicatives</em> come to the rescue - and bring theirs friends <code>pure</code> and <code>&lt;*&gt;</code>.</p>

<p><a href="/writings/2012/12/05/monads-in-small-bites-part-iii-monoids/">Part III</a> introduced Monoids which model a special type of relationship involving binary functions and their identity values.</p>

<p>Now it&#8217;s time for what I hope is the post you have all been waiting for :)</p>

<h3>Monads</h3>

<h4>A word on context</h4>

<p>So far I&#8217;ve said things such as <em>wrapping</em> stuff in Functors, <em>unwrapping</em> functions from Applicatives and putting results into minimal Functors. All this really means is that [Applicative]Functors - and Monads - have associated contexts that model some sort of computation.</p>

<p>For lists, for example, this means they represent computations that can have several results - non-determinism.</p>

<p>These computations can have much greater implications though - they can represent failure (or not!), do IO and even launch nuclear missiles. The point is: when we combine Functors/Applicatives/Monads, we carry their context with us to the end - they are essentially <em>sequenced</em> together.</p>

<p>This will become clearer with an example. For once I won&#8217;t start with lists - w00t! - so get ready for it!</p>

<h3>The Maybe Monad</h3>

<p>The Maybe monad models computations that can fail. Let&#8217;s have a look at an example.</p>

<p>Say you have an e-commerce system. When placing an order, a few things need to get done:</p>

<ul>
<li>gather information about the order;</li>
<li>calculate shipping rates;</li>
<li>apply discount codes, if any, and;</li>
<li>finally place the order.</li>
</ul>


<p>The code below shows the supporting functions that will be orchestrated in order to achieve this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">defn </span><span class="nv">calculate-shipping-rate</span> <span class="p">[</span><span class="nv">address</span><span class="p">]</span>
</span><span class='line'>    <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">= </span><span class="p">(</span><span class="nf">:country</span> <span class="nv">address</span><span class="p">)</span> <span class="s">&quot;Australia&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="mf">10.0</span>
</span><span class='line'>        <span class="nv">nil</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">defn </span><span class="nv">apply-shipping-costs</span> <span class="p">[</span><span class="nv">order</span> <span class="nv">shipping-rate</span><span class="p">]</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">assoc </span><span class="nv">order</span> <span class="nv">:total</span> <span class="p">(</span><span class="nb">+ </span><span class="p">(</span><span class="nf">:total</span> <span class="nv">order</span><span class="p">)</span> <span class="nv">shipping-rate</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">defn </span><span class="nv">lookup-discount-code</span> <span class="p">[</span><span class="nv">code</span><span class="p">]</span>
</span><span class='line'>    <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">= </span><span class="nv">code</span> <span class="s">&quot;XMAS2012&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="mf">5.0</span>
</span><span class='line'>        <span class="nv">nil</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">defn </span><span class="nv">apply-discount-code</span> <span class="p">[</span><span class="nv">order</span> <span class="nv">discount</span><span class="p">]</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">assoc </span><span class="nv">order</span> <span class="nv">:total</span> <span class="p">(</span><span class="nb">- </span><span class="p">(</span><span class="nf">:total</span> <span class="nv">order</span><span class="p">)</span> <span class="nv">discount</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">defn </span><span class="nv">place</span> <span class="p">[</span><span class="nv">order</span><span class="p">]</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">prn </span><span class="p">(</span><span class="nb">str </span><span class="s">&quot;Off you go! Order total: $&quot;</span> <span class="p">(</span><span class="nf">:total</span> <span class="nv">order</span><span class="p">))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note that based on the code above, we can <em>only</em> ship to Australia and there is <em>only one</em> active discount code. Keep this in mind - you&#8217;ll see why later on.</p>

<p>Now let&#8217;s place an order for some Jalapeño sauce:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">order</span> <span class="p">{</span>
</span><span class='line'>    <span class="nv">:items</span> <span class="p">[{</span><span class="nv">:name</span> <span class="s">&quot;Jalapeño sauce&quot;</span> <span class="nv">:price</span> <span class="mf">20.0</span><span class="p">}]</span>
</span><span class='line'>    <span class="nv">:address</span> <span class="p">{</span><span class="nv">:country</span> <span class="s">&quot;Australia&quot;</span><span class="p">}</span>
</span><span class='line'>    <span class="nv">:discount-code</span> <span class="s">&quot;XMAS2012&quot;</span>
</span><span class='line'>    <span class="nv">:total</span> <span class="mf">20.0</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">shipping-rate</span> <span class="p">(</span><span class="nf">calculate-shipping-rate</span> <span class="p">(</span><span class="nf">:address</span> <span class="nv">order</span><span class="p">)))</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">discount</span> <span class="p">(</span><span class="nf">lookup-discount-code</span> <span class="p">(</span><span class="nf">:discount-code</span> <span class="nv">order</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nb">-&gt; </span><span class="nv">order</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">apply-shipping-costs</span> <span class="nv">shipping-rate</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">apply-discount-code</span> <span class="nv">discount</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">place</span><span class="p">))</span>
</span><span class='line'><span class="c1">;; &quot;Off you go! Order total: $25.0&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Great! Soon I&#8217;ll be receiving some hot sauce to go with my burritos!</p>

<p>But wait, what if I had mistakenly set my address to somewhere other than Australia? How would this code behave?</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">another-order</span> <span class="p">{</span>
</span><span class='line'>    <span class="nv">:items</span> <span class="p">[{</span><span class="nv">:name</span> <span class="s">&quot;Jalapeño sauce&quot;</span> <span class="nv">:price</span> <span class="mf">20.0</span><span class="p">}]</span>
</span><span class='line'>    <span class="nv">:address</span> <span class="p">{</span><span class="nv">:country</span> <span class="s">&quot;Brazil&quot;</span><span class="p">}</span>
</span><span class='line'>    <span class="nv">:discount-code</span> <span class="s">&quot;HACKERZ&quot;</span>
</span><span class='line'>    <span class="nv">:total</span> <span class="mf">20.0</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">shipping-rate</span> <span class="p">(</span><span class="nf">calculate-shipping-rate</span> <span class="p">(</span><span class="nf">:address</span> <span class="nv">another-order</span><span class="p">)))</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">discount</span> <span class="p">(</span><span class="nf">lookup-discount-code</span> <span class="p">(</span><span class="nf">:discount-code</span> <span class="nv">another-order</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nb">-&gt; </span><span class="nv">another-order</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">apply-shipping-costs</span> <span class="nv">shipping-rate</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">apply-discount-code</span> <span class="nv">discount</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">place</span><span class="p">))</span>
</span><span class='line'><span class="c1">;; NullPointerException   [trace missing]</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>Oops</strong>! Your e-commerce system just crashed! Not cool. But hey, this is easy to fix, right? We could just change our <em>apply-shipping-costs</em> function to something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">defn </span><span class="nv">apply-shipping-costs</span> <span class="p">[</span><span class="nv">order</span> <span class="nv">shipping-rate</span><span class="p">]</span>
</span><span class='line'>    <span class="p">(</span><span class="k">if </span><span class="nv">shipping-rate</span>
</span><span class='line'>        <span class="p">(</span><span class="nb">assoc </span><span class="nv">order</span> <span class="nv">:total</span> <span class="p">(</span><span class="nb">+ </span><span class="p">(</span><span class="nf">:total</span> <span class="nv">order</span><span class="p">)</span> <span class="nv">shipping-rate</span><span class="p">))</span>
</span><span class='line'>        <span class="nv">order</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">;;Remember we only support one discount code so the same problem could happen again</span>
</span><span class='line'><span class="c1">;;We need to change the apply-discount-code function as well</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">defn </span><span class="nv">apply-discount-code</span> <span class="p">[</span><span class="nv">order</span> <span class="nv">discount</span><span class="p">]</span>
</span><span class='line'>    <span class="p">(</span><span class="k">if </span><span class="nv">discount</span>
</span><span class='line'>        <span class="p">(</span><span class="nb">assoc </span><span class="nv">order</span> <span class="nv">:total</span> <span class="p">(</span><span class="nb">- </span><span class="p">(</span><span class="nf">:total</span> <span class="nv">order</span><span class="p">)</span> <span class="nv">discount</span><span class="p">))</span>
</span><span class='line'>        <span class="nv">order</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now let&#8217;s see what happens:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">shipping-rate</span> <span class="p">(</span><span class="nf">calculate-shipping-rate</span> <span class="p">(</span><span class="nf">:address</span> <span class="nv">another-order</span><span class="p">)))</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">discount</span> <span class="p">(</span><span class="nf">lookup-discount-code</span> <span class="p">(</span><span class="nf">:discount-code</span> <span class="nv">another-order</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nb">-&gt; </span><span class="nv">another-order</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">apply-shipping-costs</span> <span class="nv">shipping-rate</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">apply-discount-code</span> <span class="nv">discount</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">place</span><span class="p">))</span>
</span><span class='line'><span class="c1">;; &quot;Off you go! Order total: $15.0&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Well, it doesn&#8217;t <em>crash</em> but we can&#8217;t ship to Brazil anyway! So the code is <em>still</em> incorrect! What we really want is a way to halt the whole computation - placing an order - if any of those steps fail.</p>

<p>Of course we could fix it with a couple more <em>if</em> forms before trying to call the <em>place</em> function but you see where this is going.</p>

<p>Essentially our nice little functions became burdened with <em>context</em>: each of them is now aware that they can fail and need to cater for it.</p>

<h3>Enter the Monad</h3>

<p>I&#8217;ll jump straight to how the code could look like if we had monads - it won&#8217;t work now because we haven&#8217;t actually implemented the monad yet, but this should whet your appetite.</p>

<p>Also, assume we reversed the changes from before - the functions don&#8217;t have the <em>if</em> forms checking its arguments any longer, just like in the original version. Here&#8217;s the code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">domonad</span> <span class="nv">maybe-monad</span>
</span><span class='line'>    <span class="p">[</span><span class="nv">order</span> <span class="nv">order</span>
</span><span class='line'>     <span class="nv">shipping-rate</span> <span class="p">(</span><span class="nf">calculate-shipping-rate</span> <span class="p">(</span><span class="nf">:address</span> <span class="nv">order</span><span class="p">))</span>
</span><span class='line'>     <span class="nv">discount</span> <span class="p">(</span><span class="nf">lookup-discount-code</span> <span class="p">(</span><span class="nf">:discount-code</span> <span class="nv">order</span><span class="p">))]</span>
</span><span class='line'>     <span class="p">(</span><span class="nb">-&gt; </span><span class="nv">order</span>
</span><span class='line'>        <span class="p">(</span><span class="nf">apply-shipping-costs</span> <span class="nv">shipping-rate</span><span class="p">)</span>
</span><span class='line'>        <span class="p">(</span><span class="nf">apply-discount-code</span> <span class="nv">discount</span><span class="p">)</span>
</span><span class='line'>        <span class="p">(</span><span class="nf">place</span><span class="p">)))</span>
</span><span class='line'><span class="c1">;;&quot;Off you go! Order total: $25.0&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">domonad</span> <span class="nv">maybe-monad</span>
</span><span class='line'>    <span class="p">[</span><span class="nv">order</span> <span class="nv">another-order</span>
</span><span class='line'>     <span class="nv">shipping-rate</span> <span class="p">(</span><span class="nf">calculate-shipping-rate</span> <span class="p">(</span><span class="nf">:address</span> <span class="nv">order</span><span class="p">))</span>
</span><span class='line'>     <span class="nv">discount</span> <span class="p">(</span><span class="nf">lookup-discount-code</span> <span class="p">(</span><span class="nf">:discount-code</span> <span class="nv">order</span><span class="p">))]</span>
</span><span class='line'>     <span class="p">(</span><span class="nb">-&gt; </span><span class="nv">order</span>
</span><span class='line'>        <span class="p">(</span><span class="nf">apply-shipping-costs</span> <span class="nv">shipping-rate</span><span class="p">)</span>
</span><span class='line'>        <span class="p">(</span><span class="nf">apply-discount-code</span> <span class="nv">discount</span><span class="p">)</span>
</span><span class='line'>        <span class="p">(</span><span class="nf">place</span><span class="p">)))</span>
</span><span class='line'><span class="c1">;; nil</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>domonad</code> receives the monad you want to operate on, a vector of bindings and an expression that&#8217;s the final result of the whole thing.</p>

<p>Is your mind blown yet? :) Somehow the whole operation fails and yields <code>nil</code> in the second call to <em>domonad</em> above - without any <em>if</em> forms and without crashing! To see why that is, I&#8217;ll now explain the monad type class from Haskell.</p>

<h3>The Monad Type Class</h3>

<p>Here&#8217;s the Haskell definition of the Monad type class (I left the <code>fail</code> function out so we can focus on the core of it):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='haskell'><span class='line'><span class="kr">class</span> <span class="kt">Monad</span> <span class="n">m</span> <span class="kr">where</span>
</span><span class='line'>    <span class="n">return</span> <span class="ow">::</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">m</span> <span class="n">a</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">(</span><span class="o">&gt;&gt;=</span><span class="p">)</span> <span class="ow">::</span> <span class="n">m</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="p">(</span><span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">m</span> <span class="n">b</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="n">m</span> <span class="n">b</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">(</span><span class="o">&gt;&gt;</span><span class="p">)</span> <span class="ow">::</span> <span class="n">m</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">m</span> <span class="n">b</span> <span class="ow">-&gt;</span> <span class="n">m</span> <span class="n">b</span>
</span><span class='line'>    <span class="n">x</span> <span class="o">&gt;&gt;</span> <span class="n">y</span> <span class="ow">=</span> <span class="n">x</span> <span class="o">&gt;&gt;=</span> <span class="nf">\</span><span class="kr">_</span> <span class="ow">-&gt;</span> <span class="n">y</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&#8217;s distill those bad ass type signatures:</p>

<blockquote><p><strong>return</strong> - much like <code>pure</code> from <a href="/writings/2012/12/02/monads-in-small-bites-part-ii-applicative-functors/">Applicative Functors</a>, <code>return</code> is responsible for wrapping a value of type <code>a</code> into a minimum context Monad that yields a value of type <code>a</code> - referred to as a <em>monadic value</em>.</p>

<p><strong>(>>=)</strong> - often called <code>bind</code> - is a function of two arguments. The first is a <em>monadic value</em> of type <code>a</code> and the second is a function that receives a value of type <code>a</code> and returns a monadic value of type <code>m b</code> which is also the overall result of the function.</p>

<p>In other words: <code>bind</code> <em>runs</em> the monad <code>m a</code>, feeding the yielded <code>a</code> value into the function it received as an argument - any context carried by that monad will be taken into account.</p>

<p><strong>(>>)</strong> - often called <code>then</code> - This function receives two monads, <code>m a</code> and <code>m b</code>, and returns a monad of type <code>m b</code>. It is generally used when you&#8217;re interested in the side effects - the context - carried out by the monad <code>m a</code> but doesn&#8217;t care about the value <code>a</code> it yields.  It&#8217;s rarely implemented in specific monads because the type class provides a default implementation:</p>

<p>It applies <code>bind</code> to the monad <code>x</code> and a function that ignores its argument (<code>\_ -&gt; y</code>) - which by convention is represented by an <em>underscore</em> - and simply yields the monad <code>y</code>: that&#8217;s the final result of the computation.</p></blockquote>

<p>I won&#8217;t be implementing <code>then</code> in Clojure though - I&#8217;ll focus on <code>return</code> and <code>bind</code>, since <code>then</code> is essentially a helper function you could write yourself.</p>

<h4>The Maybe Monad - Clojure edition</h4>

<p>With definitions out of the way, let&#8217;s implement the Clojure version of the Maybe monad.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">maybe-monad</span> <span class="p">{</span>
</span><span class='line'>    <span class="nv">:return</span> <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">v</span><span class="p">]</span> <span class="nv">v</span><span class="p">)</span>
</span><span class='line'>    <span class="nv">:bind</span> <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">mv</span> <span class="nv">f</span><span class="p">]</span>
</span><span class='line'>            <span class="p">(</span><span class="k">if </span><span class="nv">mv</span>
</span><span class='line'>                <span class="p">(</span><span class="nf">f</span> <span class="nv">mv</span><span class="p">)</span>
</span><span class='line'>                <span class="nv">nil</span><span class="p">))})</span>
</span></code></pre></td></tr></table></div></figure>


<p>Yup. That&#8217;s <em>it</em>.</p>

<p>For the maybe monad, all its context needs to represent is a single value or the absence of value. We do this inside <code>bind</code> by checking if the monadic value <code>mv</code> is <code>nil</code>. If it isn&#8217;t, we apply <code>f</code> to it, which will yield another monadic value. If, on the other hand, <code>mv</code> IS <code>nil</code>, we just return <code>nil</code>, bypassing the function application entirely.</p>

<p><code>return</code>, as we saw, wraps a value into a minimal monad. In this case this is the value itself, so we just return it untouched.</p>

<p>This is how one may go about using it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nb">-&gt; </span><span class="nv">another-order</span>
</span><span class='line'>    <span class="p">((</span><span class="nf">:bind</span> <span class="nv">maybe-monad</span><span class="p">)</span>
</span><span class='line'>     <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">order</span><span class="p">]</span>
</span><span class='line'>       <span class="p">(</span><span class="nb">-&gt; </span><span class="p">(</span><span class="nf">calculate-shipping-rate</span> <span class="p">(</span><span class="nf">:address</span> <span class="nv">order</span><span class="p">))</span>
</span><span class='line'>           <span class="p">((</span><span class="nf">:bind</span> <span class="nv">maybe-monad</span><span class="p">)</span>
</span><span class='line'>            <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">shipping-rate</span><span class="p">]</span>
</span><span class='line'>              <span class="p">(</span><span class="nb">-&gt; </span><span class="p">(</span><span class="nf">lookup-discount-code</span> <span class="p">(</span><span class="nf">:discount-code</span> <span class="nv">order</span><span class="p">))</span>
</span><span class='line'>                  <span class="p">((</span><span class="nf">:bind</span> <span class="nv">maybe-monad</span><span class="p">)</span>
</span><span class='line'>                   <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">discount</span><span class="p">]</span>
</span><span class='line'>                     <span class="p">((</span><span class="nf">:return</span> <span class="nv">maybe-monad</span><span class="p">)</span>
</span><span class='line'>                      <span class="p">(</span><span class="nb">-&gt; </span><span class="nv">order</span>
</span><span class='line'>                        <span class="p">(</span><span class="nf">apply-shipping-costs</span> <span class="nv">shipping-rate</span><span class="p">)</span> <span class="p">(</span>
</span><span class='line'>                        <span class="nv">apply-discount-code</span> <span class="nv">discount</span><span class="p">)</span>
</span><span class='line'>                        <span class="p">(</span><span class="nf">place</span><span class="p">))))))))))))</span>
</span><span class='line'><span class="c1">;; nil</span>
</span></code></pre></td></tr></table></div></figure>


<p><em>WOW!</em> That is awful! And I won&#8217;t blame you for not wanting to read through this aberration. But trust me, it does the job.</p>

<p>However, you&#8217;re probably thinking: that looks <em>nothing</em> like the nice little <code>domonad</code> notation we saw earlier!</p>

<p>Well, you&#8217;re right. That&#8217;s because <code>domonad</code> is a <a href="http://clojure.org/macros">macro</a> - it gives us some syntactic sugar that expands into the real code shown above. In order to be able to use the <code>domonad</code> notation, paste the following into your REPL:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">defn </span><span class="nv">monad-steps</span>
</span><span class='line'>    <span class="p">([</span><span class="nv">monad</span> <span class="nv">steps</span> <span class="nv">expr</span><span class="p">]</span>
</span><span class='line'>        <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">seq </span><span class="nv">steps</span><span class="p">)</span>
</span><span class='line'>            <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">fst</span> <span class="p">(</span><span class="nb">first </span><span class="nv">steps</span><span class="p">)</span>
</span><span class='line'>                  <span class="nv">snd</span> <span class="p">(</span><span class="nb">second </span><span class="nv">steps</span><span class="p">)]</span>
</span><span class='line'>                  <span class="o">`</span><span class="p">((</span><span class="nf">:bind</span> <span class="nv">~monad</span><span class="p">)</span>
</span><span class='line'>                    <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">~</span><span class="p">(</span><span class="nb">symbol </span><span class="nv">fst</span><span class="p">)]</span>
</span><span class='line'>                        <span class="p">(</span><span class="nb">-&gt; </span> <span class="nv">~snd</span> <span class="nv">~</span><span class="p">(</span><span class="nf">monad-steps</span> <span class="nv">monad</span> <span class="p">(</span><span class="nb">subvec </span><span class="nv">steps</span> <span class="mi">2</span><span class="p">)</span> <span class="nv">expr</span><span class="p">)))))</span>
</span><span class='line'>            <span class="nv">expr</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">defmacro </span><span class="nv">domonad</span> <span class="p">[</span><span class="nv">monad</span> <span class="nv">steps</span> <span class="nv">expr</span><span class="p">]</span>
</span><span class='line'>    <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">args</span> <span class="p">(</span><span class="nb">map </span><span class="nv">first</span> <span class="p">(</span><span class="nf">partition</span> <span class="mi">2</span> <span class="nv">steps</span><span class="p">))</span>
</span><span class='line'>          <span class="nv">forms</span> <span class="p">(</span><span class="nb">map </span><span class="nv">second</span> <span class="p">(</span><span class="nf">partition</span> <span class="mi">2</span> <span class="nv">steps</span><span class="p">))</span>
</span><span class='line'>          <span class="nv">new-steps</span> <span class="p">(</span><span class="nb">subvec </span><span class="p">(</span><span class="nf">vec</span> <span class="p">(</span><span class="nb">interleave </span><span class="p">(</span><span class="nb">cons </span><span class="nv">nil</span> <span class="nv">args</span><span class="p">)</span> <span class="nv">forms</span><span class="p">))</span> <span class="mi">2</span><span class="p">)]</span>
</span><span class='line'>          <span class="o">`</span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">m</span><span class="o">#</span> <span class="nv">~monad</span><span class="p">]</span>
</span><span class='line'>            <span class="p">(</span><span class="nb">-&gt; </span><span class="nv">~</span><span class="p">(</span><span class="nb">second </span><span class="nv">steps</span><span class="p">)</span>
</span><span class='line'>                <span class="nv">~</span><span class="p">(</span><span class="nf">monad-steps</span> <span class="nv">monad</span> <span class="nv">new-steps</span>
</span><span class='line'>                    <span class="o">`</span><span class="p">((</span><span class="nf">:bind</span> <span class="nv">~monad</span><span class="p">)</span> <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">~</span><span class="p">(</span><span class="nb">symbol </span><span class="p">(</span><span class="nb">last </span><span class="nv">args</span><span class="p">))]</span> <span class="p">((</span><span class="nf">:return</span> <span class="nv">~monad</span><span class="p">)</span> <span class="nv">~expr</span><span class="p">))))))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>All set! Now you should be able to run the examples that use <code>domonad</code> without any hiccups. Give it a shot:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">domonad</span> <span class="nv">maybe-monad</span>
</span><span class='line'>    <span class="p">[</span><span class="nv">order</span> <span class="nv">another-order</span>
</span><span class='line'>     <span class="nv">shipping-rate</span> <span class="p">(</span><span class="nf">calculate-shipping-rate</span> <span class="p">(</span><span class="nf">:address</span> <span class="nv">order</span><span class="p">))</span>
</span><span class='line'>     <span class="nv">discount</span> <span class="p">(</span><span class="nf">lookup-discount-code</span> <span class="p">(</span><span class="nf">:discount-code</span> <span class="nv">order</span><span class="p">))]</span>
</span><span class='line'>     <span class="p">(</span><span class="nb">-&gt; </span><span class="nv">order</span>
</span><span class='line'>        <span class="p">(</span><span class="nf">apply-shipping-costs</span> <span class="nv">shipping-rate</span><span class="p">)</span>
</span><span class='line'>        <span class="p">(</span><span class="nf">apply-discount-code</span> <span class="nv">discount</span><span class="p">)</span>
</span><span class='line'>        <span class="p">(</span><span class="nf">place</span><span class="p">)))</span>
</span><span class='line'><span class="c1">;; nil</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p><strong>Note:</strong> macros can be daunting at times so don&#8217;t worry too much about its implementation. It&#8217;s way more important to me that you understand the end result than it is to be able to implement the macro yourself - but by all means dissect this implementation if you feel inclined to do so :)</p></blockquote>

<p>Now that&#8217;s way better. The <em>maybe</em> monad abstracted away the logic behind computations that can fail so you don&#8217;t have to worry about it in your functions  - you can just focus on writing them.</p>

<p>In the end I also believe it aids readability once you get used to it.</p>

<h3>Don&#8217;t break the law</h3>

<p>Monads have laws of their own too! Let&#8217;s have a look at them.</p>

<h4>Right unit</h4>

<blockquote><p>Binding a monadic value <code>m</code> to <code>return</code> should be equal to <code>m</code> itself</p></blockquote>

<p>In Haskell speak:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='haskell'><span class='line'><span class="nf">m</span> <span class="o">&gt;&gt;=</span> <span class="n">return</span> <span class="ow">=</span>  <span class="n">m</span>
</span></code></pre></td></tr></table></div></figure>


<p>The proof in Clojure:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">m</span> <span class="mi">10</span><span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">&gt;&gt;=</span> <span class="p">(</span><span class="nf">:bind</span> <span class="nv">maybe-monad</span><span class="p">))</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">return</span> <span class="p">(</span><span class="nf">:return</span> <span class="nv">maybe-monad</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="c1">;; given the above, this...</span>
</span><span class='line'><span class="p">(</span><span class="nf">&gt;&gt;=</span> <span class="nv">m</span> <span class="nv">return</span><span class="p">)</span> <span class="c1">;; 10</span>
</span><span class='line'>
</span><span class='line'><span class="c1">;;is the same as</span>
</span><span class='line'><span class="nv">m</span> <span class="c1">;; 10</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Left unit</h4>

<blockquote><p>Applying <code>return</code> to <code>x</code> and then applying <code>&gt;&gt;=</code> to the resulting value and <code>f</code>should be the same as applying <code>f</code> directly to <code>x</code></p></blockquote>

<p>In Haskell speak:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='haskell'><span class='line'><span class="nf">return</span> <span class="n">x</span> <span class="o">&gt;&gt;=</span> <span class="n">f</span> <span class="ow">=</span>  <span class="n">f</span> <span class="n">x</span>
</span></code></pre></td></tr></table></div></figure>


<p>The proof in Clojure:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">x</span> <span class="mi">10</span><span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">&gt;&gt;=</span> <span class="p">(</span><span class="nf">:bind</span> <span class="nv">maybe-monad</span><span class="p">))</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">return</span> <span class="p">(</span><span class="nf">:return</span> <span class="nv">maybe-monad</span><span class="p">))</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">f</span> <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">v</span><span class="p">]</span> <span class="p">(</span><span class="nb">* </span><span class="nv">v</span> <span class="mi">2</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="c1">;; given the above, this...</span>
</span><span class='line'><span class="p">(</span><span class="nb">-&gt; </span><span class="p">(</span><span class="nf">return</span> <span class="nv">x</span><span class="p">)</span> <span class="p">(</span><span class="nf">&gt;&gt;=</span> <span class="nv">f</span><span class="p">))</span> <span class="c1">;; 20</span>
</span><span class='line'>
</span><span class='line'><span class="c1">;;is the same as</span>
</span><span class='line'><span class="p">(</span><span class="nf">f</span> <span class="nv">x</span><span class="p">)</span> <span class="c1">;; 20</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Associativity</h4>

<blockquote><p>Binding <code>m</code> to <code>f</code> and then applying <code>&gt;&gt;=</code> to the result and <code>g</code> should be the same as applying <code>&gt;&gt;=</code> to <code>m</code> and a function of argument <code>x</code> that first applies <code>f</code> to <code>x</code> and then binds it to <code>g</code>.</p></blockquote>

<p>Phew&#8230;another mouthful, huh? Code should make it clearer. As usual, Haskell comes first:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='haskell'><span class='line'><span class="p">(</span><span class="n">m</span> <span class="o">&gt;&gt;=</span> <span class="n">f</span><span class="p">)</span> <span class="o">&gt;&gt;=</span> <span class="n">g</span>  <span class="ow">=</span>  <span class="n">m</span> <span class="o">&gt;&gt;=</span> <span class="p">(</span><span class="nf">\</span><span class="n">x</span> <span class="ow">-&gt;</span> <span class="n">f</span> <span class="n">x</span> <span class="o">&gt;&gt;=</span> <span class="n">g</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>And now let&#8217;s prove it in Clojure:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">&gt;&gt;=</span> <span class="p">(</span><span class="nf">:bind</span> <span class="nv">maybe-monad</span><span class="p">))</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">return</span> <span class="p">(</span><span class="nf">:return</span> <span class="nv">maybe-monad</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">m</span> <span class="mi">10</span><span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">f</span> <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">v</span><span class="p">]</span> <span class="p">(</span><span class="nb">* </span><span class="nv">v</span> <span class="mi">2</span><span class="p">)))</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">g</span> <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">v</span><span class="p">]</span> <span class="p">(</span><span class="nb">+ </span><span class="nv">v</span> <span class="mi">10</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="c1">;; given the above, this...</span>
</span><span class='line'><span class="p">(</span><span class="nb">-&gt; </span><span class="p">(</span><span class="nf">&gt;&gt;=</span> <span class="nv">m</span> <span class="nv">f</span><span class="p">)</span> <span class="p">(</span><span class="nf">&gt;&gt;=</span> <span class="nv">g</span><span class="p">))</span> <span class="c1">;; 30</span>
</span><span class='line'>
</span><span class='line'><span class="c1">;;is the same as</span>
</span><span class='line'><span class="p">(</span><span class="nf">&gt;&gt;=</span> <span class="nv">m</span>
</span><span class='line'>     <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">x</span><span class="p">]</span>
</span><span class='line'>        <span class="p">(</span><span class="nf">&gt;&gt;=</span> <span class="p">(</span><span class="nf">f</span> <span class="nv">x</span><span class="p">)</span> <span class="nv">g</span><span class="p">)))</span> <span class="c1">;; 30</span>
</span></code></pre></td></tr></table></div></figure>


<p>Alright, we&#8217;re getting to the end now! Hold on just a little longer!</p>

<h3>One last thing - The List Monad</h3>

<p>Yeah, I&#8217;m sure you saw this coming. Lists are monads too! I&#8217;ll make this quick and show its implementation and usage in Clojure - bear with me one last time.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">list-monad</span> <span class="p">{</span>
</span><span class='line'>    <span class="nv">:return</span> <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">v</span><span class="p">]</span> <span class="p">[</span><span class="nv">v</span><span class="p">])</span>
</span><span class='line'>    <span class="nv">:bind</span> <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">mv</span> <span class="nv">f</span><span class="p">]</span>
</span><span class='line'>        <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">seq </span><span class="nv">mv</span><span class="p">)</span>
</span><span class='line'>            <span class="p">(</span><span class="nb">apply </span><span class="nv">concat</span> <span class="p">(</span><span class="nb">map </span><span class="nv">f</span> <span class="nv">mv</span><span class="p">))</span>
</span><span class='line'>            <span class="p">[]))</span>
</span><span class='line'>    <span class="p">})</span>
</span><span class='line'>
</span><span class='line'><span class="c1">;;let&#39;s play with it</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">domonad</span> <span class="nv">list-monad</span>
</span><span class='line'>    <span class="p">[</span><span class="nv">a</span> <span class="p">[</span><span class="mi">1</span> <span class="mi">2</span><span class="p">]</span>
</span><span class='line'>     <span class="nv">b</span> <span class="p">[</span><span class="nv">a,</span> <span class="p">(</span><span class="nb">- </span><span class="nv">a</span><span class="p">)]]</span>
</span><span class='line'>     <span class="p">(</span><span class="nb">* </span><span class="mi">3</span> <span class="nv">b</span><span class="p">))</span>
</span><span class='line'><span class="c1">;; (3 -3 6 -6)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">domonad</span> <span class="nv">list-monad</span>
</span><span class='line'>    <span class="p">[</span><span class="nv">a</span> <span class="p">[</span><span class="mi">1</span> <span class="mi">2</span><span class="p">]</span>
</span><span class='line'>     <span class="nv">b</span> <span class="p">[]]</span>
</span><span class='line'>     <span class="p">(</span><span class="nb">* </span><span class="mi">3</span> <span class="nv">b</span><span class="p">))</span>
</span><span class='line'><span class="c1">;; () - an empty list. </span>
</span></code></pre></td></tr></table></div></figure>


<p>This should look familiar if you&#8217;ve used <a href="http://clojuredocs.org/clojure_core/clojure.core/for">list comprehensions</a> in Clojure or other languages such as Python:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">for </span><span class="p">[</span><span class="nv">a</span> <span class="p">[</span><span class="mi">1</span> <span class="mi">2</span><span class="p">]</span>
</span><span class='line'>     <span class="nv">b</span> <span class="p">[</span><span class="nv">a,</span> <span class="p">(</span><span class="nb">- </span><span class="nv">a</span><span class="p">)]]</span>
</span><span class='line'>     <span class="p">(</span><span class="nb">* </span><span class="mi">3</span> <span class="nv">b</span><span class="p">))</span>
</span><span class='line'><span class="c1">;; (3 -3 6 -6)</span>
</span></code></pre></td></tr></table></div></figure>


<p>See? You&#8217;ve been using monads all along and didn&#8217;t even know it! How awesome is that?</p>

<p>Also note that we didn&#8217;t need to re-implement <code>domonad</code> for the list monad. It&#8217;s a generic macro that will work with any monads you throw at it!</p>

<p>It&#8217;s interesting to see how the list and the maybe monads differ. This time, <code>return</code> puts the value <code>v</code> inside a list and returns it because for lists, a minimum monad is a list with a single element.</p>

<p><code>bind</code> is a bit more interesting. It first checks to see if <code>mv</code> is empty, in which case it returns an empty list, causing the whole computation to stop. If, however, <code>mv</code> is NOT empty, it maps <code>f</code> over every element in <code>mv</code>.</p>

<p>The resulting list is potentially a list of lists, since functions fed to monads - such as <code>f</code> in this case - have to return monadic values. That&#8217;s why we then apply <code>concat</code> to the resulting list, effectively flattening it.</p>

<h3>Final words</h3>

<p>Hopefully you now have a much better understanding of Monads and should start seeing in your code use cases and/or opportunities for the monads shown here.</p>

<p>You&#8217;ll notice that this Clojure implementation of monads used only normal functions - that was by design since I wanted this implementation to be as close as possible to Clojure&#8217;s <a href="https://github.com/clojure/algo.monads">core.algo.monads</a> library. You should have a look at it.</p>

<p>Also, bear in mind that this tutorial is by no means exhaustive - there&#8217;s <strong>a lot</strong> more about monads that I could possibly cover in a blog - it was hard enough ending it here! But if you want to study more about them, I&#8217;d recommend starting with these resources:</p>

<ul>
<li><p><a href="http://learnyouahaskell.com/">Learn You a Haskell for Great Good</a> - this book is an excellent intro to Haskell and it was the approach found there that made me grok monads - highly recommended and freely available online.</p></li>
<li><p><a href="http://en.wikibooks.org/wiki/Haskell/Understanding_monads">The Monads Section on the Haskell wikibook</a> - another free online resource</p></li>
</ul>


<p>That&#8217;s it from me. I hope you enjoyed the read and if you made it until here, a big <em>thank you</em>.</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2012-12-08T17:36:00+11:00" pubdate data-updated="true">Dec 8<span>th</span>, 2012</time></div>
	<div class="tags">


	<a class='category' href='/writings/tags/clojure/'>clojure</a>, <a class='category' href='/writings/tags/functional-programming/'>functional-programming</a>, <a class='category' href='/writings/tags/haskell/'>haskell</a>


</div>
	
</div></article>


    <article class="post">
	<h1 class="title"><a href="/writings/2012/12/05/monads-in-small-bites-part-iii-monoids/">Monads in Small Bites - Part III - Monoids</a></h1>
	<div class="entry-content">
		<p>This is Part III of my Monads tutorial. Make sure you read the previous parts:</p>

<ul>
<li><p><a href="/writings/2012/11/30/monads-in-small-bites-part-i-functors/">Part I   - Functors</a></p></li>
<li><p><a href="/writings/2012/12/02/monads-in-small-bites-part-ii-applicative-functors/">Part II  - Applicative Functors</a></p></li>
<li><p>Part III - Monoids (this post)</p></li>
<li><p><a href="/writings/2012/12/08/monads-in-small-bites-part-iv-monads/">Part IV  - Monads</a></p></li>
</ul>


<h3>Monoids</h3>

<p>Simply put, Monoids describe types containing a <a href="http://en.wikipedia.org/wiki/Binary_function">binary function</a> and an identity value.</p>

<p>When applied to the identity value and a random value <code>x</code>, said function leaves its argument <code>x</code> <em>untouched</em>, returning it as a result.</p>

<p>This short description should be enough to get the conversation started.</p>

<p>Here&#8217;s how Haskell defines a Monoid:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='haskell'><span class='line'><span class="kr">class</span> <span class="kt">Monoid</span> <span class="n">m</span> <span class="kr">where</span>
</span><span class='line'>    <span class="n">mempty</span> <span class="ow">::</span> <span class="n">m</span>
</span><span class='line'>    <span class="n">mappend</span> <span class="ow">::</span> <span class="n">m</span> <span class="ow">-&gt;</span> <span class="n">m</span> <span class="ow">-&gt;</span> <span class="n">m</span>
</span><span class='line'>    <span class="n">mconcat</span> <span class="ow">::</span> <span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="ow">-&gt;</span> <span class="n">m</span>
</span><span class='line'>    <span class="n">mconcat</span> <span class="n">ms</span> <span class="ow">=</span> <span class="n">foldr</span> <span class="n">mappend</span> <span class="n">mempty</span> <span class="n">ms</span>
</span></code></pre></td></tr></table></div></figure>


<p>This type introduces three new functions so let&#8217;s walk through each one of them:</p>

<blockquote><p><strong>mempty</strong> - I started with a lie since <code>mempty</code> isn&#8217;t actually a function. You can think of it as a constant of the same type of the Monoid <code>m</code>. It is this monoid&#8217;s identity value.</p>

<p><strong>mappend</strong> - A poorly named function, <code>mappend</code> is the binary function I mentioned earlier. It receives two arguments of type <code>m</code> and returns a value of type <code>m</code></p>

<p><strong>mconcat</strong> - It receives a list of Monoids <code>m</code> and reduces them to a single Monoid of type <code>m</code>. What&#8217;s interesting about this snippet is that the Monoid type class provides a default implementation for <code>mconcat</code>: it simply calls <em><a href="http://www.haskell.org/haskellwiki/Foldr_Foldl_Foldl" title="">foldr</a></em> with the binary function <code>mappend</code>, a starting value of <code>mempty</code> and the list of Monoid values <code>ms</code></p></blockquote>

<p>Enough Haskell! Let&#8217;s have a look at a few examples.</p>

<p>Did you know that, in Clojure,  the functions <code>*</code> and <code>+</code> are monoids? Yup. But don&#8217;t take my word for it. Let me prove it to you:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span> <span class="nv">mempty</span> <span class="p">(</span><span class="nf">+</span><span class="p">))</span> <span class="c1">;; 0</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span> <span class="nv">mappend</span> <span class="nv">+</span><span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="k">defn </span><span class="nv">mconcat</span> <span class="p">[</span><span class="nv">ms</span><span class="p">]</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">reduce </span><span class="nv">mappend</span> <span class="nv">mempty</span> <span class="nv">ms</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">mappend</span> <span class="mi">3</span> <span class="mi">4</span><span class="p">)</span> <span class="c1">;; 7</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">mconcat</span> <span class="p">[</span><span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span><span class="p">])</span> <span class="c1">;; 9</span>
</span></code></pre></td></tr></table></div></figure>


<p>Whoa!  What happened here? Am I just making this stuff up?</p>

<p>Not really. I only defined the same haskell names to their Clojure counterparts for clarity. Totally overkill. The code above is the same as:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">+</span><span class="p">)</span> <span class="c1">;; 0</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nb">+ </span><span class="mi">3</span> <span class="mi">4</span><span class="p">)</span> <span class="c1">;; 7</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nb">reduce </span><span class="nv">+</span> <span class="p">[</span><span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span><span class="p">])</span> <span class="c1">;; 9</span>
</span></code></pre></td></tr></table></div></figure>


<p>Did you notice that on the second call to <code>reduce</code> we did not provide an initial value? That&#8217;s because <code>reduce</code> will attempt to get its initial accumulator by calling the reducing function without arguments - hence <code>mempty == (+)</code>.</p>

<p>So that means we don&#8217;t even need an <code>mconcat</code> function since in Clojure,  <code>reduce</code> works with monoids as well!</p>

<blockquote><p><strong>Update</strong>: this isn&#8217;t entirely true. When I wrote this post I had in mind the version of <code>reduce</code> provided by the Clojure (1.5+) reducers library. The <a href="https://github.com/clojure/clojure/blob/master/src/clj/clojure/core/reducers.clj#L71">source code</a> shows how that is the case.</p>

<p>The implementation of <code>reduce</code> in <code>clojure.core</code> however uses the first element of the collection being reduced over as its seed.</p></blockquote>

<p>But how the hell do you create a monoid in Clojure then? I&#8217;m glad you asked. Let&#8217;s create our own <em>plus-monoid</em>!</p>

<h4>Your first monoid</h4>

<p>In <a href="/writings/2012/11/30/monads-in-small-bites-part-i-functors/">Part I</a> I implemented Functors using <a href="http://clojure.org/protocols">protocols</a> and <a href="http://clojuredocs.org/clojure_core/clojure.core/defrecord">records</a>. In <a href="/writings/2012/12/02/monads-in-small-bites-part-ii-applicative-functors/">Part II</a> I showed how Applicative Functors could be implemented using <a href="http://clojure.org/multimethods">multimethods</a>.</p>

<p>This time around I won&#8217;t be using any of these. I&#8217;ll implement Monoids using pure functions:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">defn </span><span class="nv">plus-monoid</span>
</span><span class='line'>    <span class="p">([]</span>
</span><span class='line'>        <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>    <span class="p">([</span><span class="nv">a</span> <span class="nv">b</span><span class="p">]</span>
</span><span class='line'>        <span class="p">(</span><span class="nb">+ </span><span class="nv">a</span> <span class="nv">b</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">plus-monoid</span><span class="p">)</span> <span class="c1">;; 0 - same as mempty</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">plus-monoid</span> <span class="mi">3</span> <span class="mi">4</span><span class="p">)</span> <span class="c1">;; 7 - same as mappend</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nb">reduce </span><span class="nv">plus-monoid</span> <span class="p">[</span><span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span><span class="p">])</span> <span class="c1">;; 9 - when working with monoids, reduce is the same as mconcat</span>
</span></code></pre></td></tr></table></div></figure>


<p>We start by defining a function with multiple arities. The first body receives no arguments, so we just return the identity value for summation, which is <em>0 (zero)</em>. The second body receives two arguments so we can just add them up. Multiplication can be implemented in a similar fashion but obviously with the identity value of <em>one</em>.</p>

<p>Easy, huh?</p>

<p>Oh, by the way, lists are Monoids too! Who&#8217;d have thought?</p>

<p>Here&#8217;s its Clojure implementation:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">defn </span><span class="nv">list-monoid</span>
</span><span class='line'>    <span class="p">([]</span>
</span><span class='line'>        <span class="o">&#39;</span><span class="p">())</span>
</span><span class='line'>    <span class="p">([</span><span class="nv">a</span> <span class="nv">b</span><span class="p">]</span>
</span><span class='line'>        <span class="p">(</span><span class="nb">concat </span><span class="nv">a</span> <span class="nv">b</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">list-monoid</span><span class="p">)</span> <span class="c1">;; () - remember, same as mempty</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">list-monoid</span> <span class="p">[</span><span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span><span class="p">]</span> <span class="p">[</span><span class="mi">4</span> <span class="mi">5</span> <span class="mi">6</span><span class="p">])</span> <span class="c1">;; (1 2 3 4 5 6) - remember, same as mappend</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nb">reduce </span><span class="nv">list-monoid</span> <span class="p">[[</span><span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span><span class="p">]</span> <span class="p">[</span><span class="mi">4</span> <span class="mi">5</span> <span class="mi">6</span><span class="p">]</span> <span class="p">[</span><span class="mi">7</span> <span class="mi">8</span> <span class="mi">9</span><span class="p">]])</span> <span class="c1">;; (1 2 3 4 5 6 7 8 9) - mconcat in action</span>
</span></code></pre></td></tr></table></div></figure>


<p>Same rules apply but for lists <code>mappend</code> is achieved by using <code>concat</code> inside our monoid function.</p>

<p>Also, since our binary function concatenates two lists together it makes sense that <code>mempty</code> is <code>()</code> (the empty list). Remember <code>mempty</code> is supposed to be an identity value so if we stitch <code>()</code> and <code>[1 2 3]</code> together, we&#8217;re left with <code>[1 2 3]</code> which is exactly what we&#8217;d expect.</p>

<blockquote><p>You can see now why I said <code>mappend</code> was poorly named. While it makes sense when you think about lists, <code>mappend</code> doesn&#8217;t do any appending in our <em>plus-monoid</em> and in fact most monoids don&#8217;t append anything. Just keep this in mind if you see any haskell code using it: <code>mappend</code> is just a binary function.</p></blockquote>

<h3>Don&#8217;t break the law</h3>

<p>You saw this coming, huh? Monoids also come with a couple of laws. You know the drill. Let&#8217;s prove they both hold.</p>

<h4>Identity</h4>

<blockquote><p>Applying <code>mappend</code> to <code>mempty</code> and a monoid <code>x</code> should be the same as the original <code>x</code> monoid.</p></blockquote>

<p>In Haskell:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='haskell'><span class='line'><span class="nf">mappend</span> <span class="n">mempty</span> <span class="n">x</span> <span class="ow">=</span> <span class="n">x</span>
</span><span class='line'><span class="nf">mappend</span> <span class="n">x</span> <span class="n">mempty</span> <span class="ow">=</span> <span class="n">x</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>And the proof in Clojure:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="c1">;; first, the plus-monoid</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">mempty</span> <span class="p">(</span><span class="nf">plus-monoid</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">x</span> <span class="mi">10</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">;; This...</span>
</span><span class='line'><span class="p">(</span><span class="nf">plus-monoid</span> <span class="nv">mempty</span> <span class="nv">x</span><span class="p">)</span> <span class="c1">;; 10</span>
</span><span class='line'>
</span><span class='line'><span class="c1">;; ...is the same as:</span>
</span><span class='line'><span class="p">(</span><span class="nf">plus-monoid</span> <span class="nv">x</span> <span class="nv">mempty</span><span class="p">)</span> <span class="c1">;; 10</span>
</span><span class='line'>
</span><span class='line'><span class="c1">;;now, the list-monoid</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">mempty</span> <span class="p">(</span><span class="nf">list-monoid</span><span class="p">))</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">x</span> <span class="p">[</span><span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span><span class="p">])</span>
</span><span class='line'>
</span><span class='line'><span class="c1">;; This...</span>
</span><span class='line'><span class="p">(</span><span class="nf">list-monoid</span> <span class="nv">mempty</span> <span class="nv">x</span><span class="p">)</span> <span class="c1">;; (1 2 3)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">;; ...is the same as:</span>
</span><span class='line'><span class="p">(</span><span class="nf">list-monoid</span> <span class="nv">x</span> <span class="nv">mempty</span><span class="p">)</span> <span class="c1">;; (1 2 3)</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Associativity</h4>

<blockquote><p>Applying <code>mappend</code> to a monoid <code>x</code> and the result of applying <code>mappend</code> to the monoids <code>y</code> and <code>z</code> should be the same as first applying <code>mappend</code> to the monoids <code>x</code> and <code>y</code> and then applying <code>mappend</code> to the resulting monoid and the monoid <code>z</code></p></blockquote>

<p>In Haskell:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='haskell'><span class='line'><span class="nf">mappend</span> <span class="n">x</span> <span class="p">(</span><span class="n">mappend</span> <span class="n">y</span> <span class="n">z</span><span class="p">)</span> <span class="ow">=</span> <span class="n">mappend</span> <span class="p">(</span><span class="n">mappend</span> <span class="n">x</span> <span class="n">y</span><span class="p">)</span> <span class="n">z</span>
</span></code></pre></td></tr></table></div></figure>


<p>And the proof in Clojure - remember that calling the monoid function with two arguments is equivalent to <code>mappend</code> in haskell:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="c1">;; first, the plus-monoid</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">x</span> <span class="mi">10</span><span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">y</span> <span class="mi">25</span><span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">z</span> <span class="mi">40</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">;; This...</span>
</span><span class='line'><span class="p">(</span><span class="nf">plus-monoid</span> <span class="nv">x</span> <span class="p">(</span><span class="nf">plus-monoid</span> <span class="nv">y</span> <span class="nv">z</span><span class="p">))</span> <span class="c1">;; 75</span>
</span><span class='line'>
</span><span class='line'><span class="c1">;; ...is the same as:</span>
</span><span class='line'><span class="p">(</span><span class="nf">plus-monoid</span> <span class="p">(</span><span class="nf">plus-monoid</span> <span class="nv">x</span> <span class="nv">y</span><span class="p">)</span> <span class="nv">z</span><span class="p">)</span> <span class="c1">;; 75</span>
</span><span class='line'>
</span><span class='line'><span class="c1">;;now, the list-monoid</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">x</span> <span class="p">[</span><span class="mi">40</span><span class="p">])</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">y</span> <span class="p">[</span><span class="mi">10</span> <span class="mi">25</span><span class="p">])</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">z</span> <span class="p">[</span><span class="mi">50</span><span class="p">])</span>
</span><span class='line'>
</span><span class='line'><span class="c1">;; This...</span>
</span><span class='line'><span class="p">(</span><span class="nf">list-monoid</span> <span class="nv">x</span> <span class="p">(</span><span class="nf">list-monoid</span> <span class="nv">y</span> <span class="nv">z</span><span class="p">))</span> <span class="c1">;; (40 10 25 50)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">;; ...is the same as:</span>
</span><span class='line'><span class="p">(</span><span class="nf">list-monoid</span> <span class="p">(</span><span class="nf">list-monoid</span> <span class="nv">x</span> <span class="nv">y</span><span class="p">)</span> <span class="nv">z</span><span class="p">)</span> <span class="c1">;; (40 10 25 50)</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Almost there&#8230;</h3>

<p>This puts an end to Part III. It&#8217;s time to head to the pub.</p>

<p>When you&#8217;re back look for the final post in these series - <a href="/writings/2012/12/08/monads-in-small-bites-part-iv-monads/">Part IV</a> - where we will conclude our journey by finally introducing Monads!</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2012-12-05T09:25:00+11:00" pubdate data-updated="true">Dec 5<span>th</span>, 2012</time></div>
	<div class="tags">


	<a class='category' href='/writings/tags/clojure/'>clojure</a>, <a class='category' href='/writings/tags/functional-programming/'>functional-programming</a>, <a class='category' href='/writings/tags/haskell/'>haskell</a>


</div>
	
</div></article>


    <article class="post">
	<h1 class="title"><a href="/writings/2012/12/02/monads-in-small-bites-part-ii-applicative-functors/">Monads in Small Bites - Part II - Applicative Functors</a></h1>
	<div class="entry-content">
		<p>This is Part II of my Monads tutorial. Make sure you read the previous parts:</p>

<ul>
<li><p><a href="/writings/2012/11/30/monads-in-small-bites-part-i-functors/">Part I   - Functors</a></p></li>
<li><p>Part II  - Applicative Functors (this post)</p></li>
<li><p><a href="/writings/2012/12/05/monads-in-small-bites-part-iii-monoids/">Part III - Monoids</a></p></li>
<li><p><a href="/writings/2012/12/08/monads-in-small-bites-part-iv-monads/">Part IV  - Monads</a></p></li>
</ul>


<h3>Applicative Functors</h3>

<p>In <a href="/writings/2012/11/30/monads-in-small-bites-part-i-functors/">Part I</a> I talked a little about Haskell type signatures and introduced Functors, which provide a way to map standard functions over values which are <em>wrapped</em> inside a Functor - we used <code>fmap</code> for that. You might want to <a href="/writings/2012/11/30/monads-in-small-bites-part-i-functors/">skim through it</a> again as a refresher.</p>

<p>Now suppose you have Functors that <em>wrap</em> functions and that you want to apply those <em>wrapped</em> functions to other Functors, maybe even composing new functions on the way!</p>

<p>What then?</p>

<p>Well you&#8217;re in luck! Applicative Functors do just that! They&#8217;re <strong>Functors on steroids</strong>.</p>

<p>Here&#8217;s how Haskell defines the Applicative data type:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='haskell'><span class='line'><span class="kr">class</span> <span class="p">(</span><span class="kt">Functor</span> <span class="n">f</span><span class="p">)</span> <span class="ow">=&gt;</span> <span class="kt">Applicative</span> <span class="n">f</span> <span class="kr">where</span>
</span><span class='line'>    <span class="n">pure</span> <span class="ow">::</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">f</span> <span class="n">a</span>
</span><span class='line'>    <span class="p">(</span><span class="o">&lt;*&gt;</span><span class="p">)</span> <span class="ow">::</span> <span class="n">f</span> <span class="p">(</span><span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">b</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="n">f</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">f</span> <span class="n">b</span>
</span></code></pre></td></tr></table></div></figure>


<p>Based on our previous knowledge of Haskell&#8217;s type signatures, we can infer from this definition that in order for it to be an Applicative Functor, <code>f</code> <em>must</em> already be a Functor.</p>

<p>Let&#8217;s break this down and have a closer look at the two new functions this type introduces:</p>

<blockquote><p><strong>pure</strong> is a function that takes a value <code>a</code> and <em>wraps</em> it into a minimal Functor <code>f</code>.</p>

<p><strong>&lt;*></strong> is a function that takes two arguments: the first is a Functor <code>f</code> that wraps a function of type <code>a -&gt; b</code>. The second argument is a Functor <code>f</code> that wraps a value - which could be a function! - of type <code>a</code>. The final result is a Functor <code>f</code> that wraps some value of type <code>b</code> - which was obtained by somehow applying the function <code>(a -&gt; b)</code> to the Functor <code>f a</code>.</p></blockquote>

<p><code>pure</code> has a straightforward explanation whereas <code>&lt;*&gt;</code> is a bit more involved.</p>

<p>To clear things up, I&#8217;ll show the type signatures again but this time as if they only worked with the List Functor that we&#8217;ve been working on:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='haskell'><span class='line'><span class="nf">pure</span> <span class="ow">::</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="p">[</span><span class="n">a</span><span class="p">]</span>
</span><span class='line'><span class="p">(</span><span class="o">&lt;*&gt;</span><span class="p">)</span> <span class="ow">::</span> <span class="p">[(</span><span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">b</span><span class="p">)]</span> <span class="ow">-&gt;</span> <span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="ow">-&gt;</span> <span class="p">[</span><span class="n">b</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&#8217;s revisit those definitions:</p>

<blockquote><p><strong>pure</strong> is a function that takes a value <code>a</code> and <em>puts</em> it into an empty list, returning the resulting single element list.</p>

<p><strong>&lt;*></strong> is a function that takes two arguments: the first is a list containing one or more functions of type <code>a -&gt; b</code>. The second argument is a list of one or more values - or functions! - of type <code>a</code>. The final result is a list of one or more values of type <code>b</code> - which was obtained by somehow applying the function <code>(a -&gt; b)</code> to the Functor <code>f a</code>.</p></blockquote>

<p>Enough definitions though! Let&#8217;s extend our List Functor and make it an Applicative as well.</p>

<p>While we&#8217;ll still be using the List Functor we implemented in <a href="/writings/2012/11/30/monads-in-small-bites-part-i-functors/">Part I</a>, this time I&#8217;ll implement its Applicative version using <a href="http://clojure.org/multimethods">multimethods</a> for a change.  Here&#8217;s the code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="c1">;; it dispatches on the record type since we could have implementations of pure for List, Maybe, Either etc...</span>
</span><span class='line'><span class="p">(</span><span class="k">defmulti </span><span class="nv">pure</span> <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">f</span> <span class="nv">_</span><span class="p">]</span> <span class="nv">f</span><span class="p">))</span>
</span><span class='line'><span class="p">(</span><span class="k">defmethod </span><span class="nv">pure</span> <span class="nv">List</span> <span class="p">[</span><span class="nv">_</span> <span class="nv">v</span><span class="p">]</span>
</span><span class='line'>    <span class="s">&quot;Wraps value v in a list&quot;</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">List</span><span class="o">.</span> <span class="p">[</span><span class="nv">v</span><span class="p">]))</span>
</span><span class='line'>
</span><span class='line'><span class="c1">;; it dispatches on the class of the Functor instance passed in the 1st argument</span>
</span><span class='line'><span class="p">(</span><span class="k">defmulti </span><span class="nv">&lt;*&gt;</span> <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">fs</span> <span class="nv">_</span><span class="p">]</span> <span class="p">(</span><span class="nb">class </span><span class="nv">fs</span><span class="p">)))</span>
</span><span class='line'><span class="p">(</span><span class="k">defmethod </span><span class="nv">&lt;*&gt;</span> <span class="nv">List</span> <span class="p">[</span><span class="nv">fs</span> <span class="nv">xs</span><span class="p">]</span>
</span><span class='line'>    <span class="s">&quot;Unwraps the functions in fs, applies them to the Functors in xs, wrapping the result at the end&quot;</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">List</span><span class="o">.</span> <span class="p">(</span><span class="k">for </span><span class="p">[</span><span class="nv">f</span> <span class="p">(</span><span class="nf">:wrapped</span> <span class="nv">fs</span><span class="p">)</span>
</span><span class='line'>                 <span class="nv">x</span> <span class="p">(</span><span class="nf">:wrapped</span> <span class="nv">xs</span><span class="p">)]</span>
</span><span class='line'>                <span class="p">(</span><span class="nf">f</span> <span class="nv">x</span><span class="p">))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>By focusing on the List as an Applicative Functor we can more easily understand what these functions do. From the code above, <code>pure</code>&#8217;s job is a simple one: all it does is <em>wrap</em> it&#8217;s argument <code>v</code> into a minimal List functor which in our case means a Functor wrapping a one element list.</p>

<p><code>&lt;*&gt;</code> on the other hand is responsible for somehow unwrapping the functions brought in by the Applicatives in <code>fs</code> and applying them to the [Applicative] Functors in <code>xs</code>. It does that by using <a href="http://clojuredocs.org/clojure_core/clojure.core/for">list comprehensions</a> and <em>wraps</em> the result into a new List Functor.</p>

<p>Study this code carefully. It <em>can</em> be tricky.</p>

<blockquote><p><strong>Note</strong>: When I first encountered <strong>&lt;*></strong> I had no idea what this function was called. I asked the twittersphere and it seems it&#8217;s called <code>apply</code>. In the process of figuring this out I was enlightened <a href="https://twitter.com/leonardo_borges/status/267777875367841792">by this conversation</a>. It turns out <code>&lt;*&gt;</code> has several names. Can you guess which one is my favorite? :)</p></blockquote>

<p>With the Applicative functions defined for our List, let&#8217;s take it for a spin:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">fs</span> <span class="p">(</span><span class="nf">List</span><span class="o">.</span> <span class="p">[</span><span class="o">#</span><span class="p">(</span><span class="nv">*</span> <span class="mi">2</span> <span class="nv">%</span><span class="p">)</span> <span class="o">#</span><span class="p">(</span><span class="nv">+</span> <span class="mi">10</span> <span class="nv">%</span><span class="p">)]))</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">xs</span> <span class="p">(</span><span class="nf">List</span><span class="o">.</span> <span class="p">[</span><span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span><span class="p">]))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">&lt;*&gt;</span> <span class="nv">fs</span> <span class="nv">xs</span><span class="p">)</span> <span class="c1">;; List{:wrapped (2 4 6 11 12 13)}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">g</span> <span class="p">(</span><span class="nf">pure</span> <span class="nv">List</span> <span class="o">#</span><span class="p">(</span><span class="nv">*</span> <span class="mi">50</span> <span class="nv">%</span><span class="p">)))</span>
</span><span class='line'><span class="p">(</span><span class="nf">&lt;*&gt;</span> <span class="nv">g</span> <span class="nv">xs</span><span class="p">)</span> <span class="c1">;; List{:wrapped (50 100 150)}</span>
</span></code></pre></td></tr></table></div></figure>


<p>There should have been no surprises here. Read the code again and make sure it&#8217;s all fresh before moving along.</p>

<h3>Don&#8217;t break the law</h3>

<p>Just as Functors, Applicative Functors also need to obey some laws:</p>

<h4>Identity</h4>

<blockquote><p>Feeding a function <code>f</code> to <code>pure</code> and applying the resulting Applicative to the Functor <code>v</code> should be the same as directly mapping <code>f</code> over the Functor <code>v</code></p></blockquote>

<p>In Haskell speak:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='haskell'><span class='line'><span class="nf">pure</span> <span class="n">f</span> <span class="o">&lt;*&gt;</span> <span class="n">v</span> <span class="ow">=</span> <span class="n">fmap</span> <span class="n">f</span> <span class="n">v</span>
</span></code></pre></td></tr></table></div></figure>


<p>And this is the proof, in Clojure:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">f</span> <span class="o">#</span><span class="p">(</span><span class="nv">+</span> <span class="mi">2</span> <span class="nv">%</span><span class="p">))</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">v</span> <span class="p">(</span><span class="nf">List</span><span class="o">.</span> <span class="p">[</span><span class="mi">10</span><span class="p">]))</span>
</span><span class='line'>
</span><span class='line'><span class="c1">;; given the above, this...</span>
</span><span class='line'><span class="p">(</span><span class="nf">&lt;*&gt;</span> <span class="p">(</span><span class="nf">pure</span> <span class="nv">List</span> <span class="nv">f</span><span class="p">)</span> <span class="nv">v</span><span class="p">)</span> <span class="c1">;; List{:wrapped (12)}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">;; ...is the same as:</span>
</span><span class='line'><span class="p">(</span><span class="nf">fmap</span> <span class="nv">v</span> <span class="nv">f</span><span class="p">)</span> <span class="c1">;; List{:wrapped (12)}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Composition</h4>

<blockquote><p>The result of <em>applying</em> an Applicative Functor that yields the <strong>function composition</strong> operator to the Applicative <code>u</code>, then apply the resulting Functor to <code>v</code> and finally applying that result to the final Applicative <code>w</code> should be the same as <em>applying</em> <code>v</code> to <code>w</code> and then <em>applying</em> <code>u</code> to the resulting <em>Applicative</em>.</p></blockquote>

<p>That was a mouthful! Let&#8217;s see how Haskell tells this story:</p>

<p>In Haskell:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='haskell'><span class='line'><span class="nf">pure</span> <span class="p">(</span><span class="o">.</span><span class="p">)</span> <span class="o">&lt;*&gt;</span> <span class="n">u</span> <span class="o">&lt;*&gt;</span> <span class="n">v</span> <span class="o">&lt;*&gt;</span> <span class="n">w</span> <span class="ow">=</span> <span class="n">u</span> <span class="o">&lt;*&gt;</span> <span class="p">(</span><span class="n">v</span> <span class="o">&lt;*&gt;</span> <span class="n">w</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>I needed to cheat a bit in Clojure to prove this law since functions are not <a href="http://www.haskell.org/haskellwiki/Currying">curried by default like they are in Haskell</a>. But this code should still clearly show how this law holds:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">u</span> <span class="p">(</span><span class="nf">List</span><span class="o">.</span> <span class="p">[</span><span class="o">#</span><span class="p">(</span><span class="nv">*</span> <span class="mi">2</span> <span class="nv">%</span><span class="p">)]))</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">v</span> <span class="p">(</span><span class="nf">List</span><span class="o">.</span> <span class="p">[</span><span class="o">#</span><span class="p">(</span><span class="nv">+</span> <span class="mi">10</span> <span class="nv">%</span><span class="p">)]))</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">w</span> <span class="p">(</span><span class="nf">List</span><span class="o">.</span> <span class="p">[</span><span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span><span class="p">]))</span>
</span><span class='line'>
</span><span class='line'><span class="c1">;; Given the above, this...</span>
</span><span class='line'><span class="p">(</span><span class="nb">-&gt; </span><span class="p">(</span><span class="nf">pure</span> <span class="nv">List</span> <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">x</span><span class="p">]</span> <span class="p">(</span><span class="nb">partial </span><span class="nv">comp</span> <span class="nv">x</span><span class="p">)))</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">&lt;*&gt;</span> <span class="nv">u</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">&lt;*&gt;</span> <span class="nv">v</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">&lt;*&gt;</span> <span class="nv">w</span><span class="p">))</span> <span class="c1">;; List{:wrapped (22 24 26)}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">;; ...is the same as:</span>
</span><span class='line'><span class="p">(</span><span class="nf">&lt;*&gt;</span> <span class="nv">u</span> <span class="p">(</span><span class="nf">&lt;*&gt;</span> <span class="nv">v</span> <span class="nv">w</span><span class="p">))</span> <span class="c1">;; List{:wrapped (22 24 26)}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Homomorphism</h4>

<blockquote><p>The result of applying the <code>pure</code> value of <code>f</code> to the <code>pure</code> value of <code>x</code> should be the same as applying <code>f</code> directly to <code>x</code> and then feeding that into <code>pure</code>.</p></blockquote>

<p>In Haskell:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='haskell'><span class='line'><span class="nf">pure</span> <span class="n">f</span> <span class="o">&lt;*&gt;</span> <span class="n">pure</span> <span class="n">x</span> <span class="ow">=</span> <span class="n">pure</span> <span class="p">(</span><span class="n">f</span> <span class="n">x</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>And in Clojure:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">f</span> <span class="o">#</span><span class="p">(</span><span class="nv">*</span> <span class="mi">2</span> <span class="nv">%</span><span class="p">))</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">x</span> <span class="mi">10</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">;; given the above, this...</span>
</span><span class='line'><span class="p">(</span><span class="nb">-&gt; </span><span class="p">(</span><span class="nf">pure</span> <span class="nv">List</span> <span class="nv">f</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">&lt;*&gt;</span> <span class="p">(</span><span class="nf">pure</span> <span class="nv">List</span> <span class="nv">x</span><span class="p">)))</span> <span class="c1">;; List{:wrapped (20)}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">;; ...is the same as:</span>
</span><span class='line'><span class="p">(</span><span class="nf">pure</span> <span class="nv">List</span> <span class="p">(</span><span class="nf">f</span> <span class="nv">x</span><span class="p">))</span> <span class="c1">;; List{:wrapped (20)}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Interchange</h4>

<blockquote><p>The result of applying an Applicative Functor <code>u</code> to the <code>pure</code> value of <code>y</code> should be the same as taking the Applicative obtained by calling <code>pure</code> with a function that applies its argument to <code>y</code> and then applying that to <code>u</code></p></blockquote>

<p>In Haskell:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='haskell'><span class='line'><span class="nf">u</span> <span class="o">&lt;*&gt;</span> <span class="n">pure</span> <span class="n">y</span> <span class="ow">=</span> <span class="n">pure</span> <span class="p">(</span><span class="o">$</span> <span class="n">y</span><span class="p">)</span> <span class="o">&lt;*&gt;</span> <span class="n">u</span>
</span></code></pre></td></tr></table></div></figure>


<p>This type signature presents new syntax so before proving the law in Clojure, I want to explain what <code>($ y)</code> means.</p>

<p>In Haskell, <code>$</code> is the function application operator. So if we give <code>y</code> a value of <em>10</em>, I can show you that in this law <code>$</code> essentially translates to a single argument function that applies its argument to <em>10</em>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='haskell'><span class='line'><span class="kr">let</span> <span class="n">double</span> <span class="n">a</span> <span class="ow">=</span> <span class="n">a</span> <span class="o">*</span> <span class="mi">2</span> <span class="c1">-- helper function. it doubles its argument</span>
</span><span class='line'>
</span><span class='line'><span class="c1">-- given the above, this...</span>
</span><span class='line'><span class="p">((</span><span class="o">$</span> <span class="mi">10</span><span class="p">)</span> <span class="n">double</span><span class="p">)</span> <span class="c1">-- 20</span>
</span><span class='line'>
</span><span class='line'><span class="c1">-- ...is the same as:</span>
</span><span class='line'><span class="kr">let</span> <span class="n">dollarTen</span> <span class="ow">=</span> <span class="p">(</span><span class="nf">\</span><span class="n">a</span> <span class="ow">-&gt;</span> <span class="p">(</span><span class="n">a</span> <span class="mi">10</span><span class="p">))</span>  <span class="c1">-- this is Haskell&#39;s lambda syntax. It&#39;s equivalent to ($ 10)</span>
</span><span class='line'><span class="p">((</span><span class="n">dollarTen</span><span class="p">)</span> <span class="n">double</span><span class="p">)</span> <span class="c1">-- 20</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now, to the proof in Clojure:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">u</span> <span class="p">(</span><span class="nf">pure</span> <span class="nv">List</span> <span class="o">#</span><span class="p">(</span><span class="nv">+</span> <span class="mi">10</span> <span class="nv">%</span><span class="p">)))</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">y</span> <span class="mi">50</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">;; given the above, this...</span>
</span><span class='line'><span class="p">(</span><span class="nf">&lt;*&gt;</span> <span class="nv">u</span> <span class="p">(</span><span class="nf">pure</span> <span class="nv">List</span> <span class="nv">y</span><span class="p">))</span> <span class="c1">;; List{:wrapped (60)}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">;; ...is the same as:</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">dollar-y</span> <span class="o">#</span><span class="p">(</span><span class="nv">%</span> <span class="nv">y</span><span class="p">))</span> <span class="c1">;; it&#39;s called dollar-y to show the correlation with the explanation above</span>
</span><span class='line'><span class="p">(</span><span class="nf">&lt;*&gt;</span> <span class="p">(</span><span class="nf">pure</span> <span class="nv">List</span> <span class="nv">dollar-y</span><span class="p">)</span> <span class="nv">u</span><span class="p">)</span> <span class="c1">;; List{:wrapped (60)}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This brings us to the end or Part II. Two down and two to go.</p>

<p>I hope you&#8217;re still with me but go home now.</p>

<p>Or better yet go to the gym lift some weights and think about these Functors on steroids. When you&#8217;re back, look out for <a href="/writings/2012/12/05/monads-in-small-bites-part-iii-monoids/">Part III</a>.</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2012-12-02T21:43:00+11:00" pubdate data-updated="true">Dec 2<span>nd</span>, 2012</time></div>
	<div class="tags">


	<a class='category' href='/writings/tags/clojure/'>clojure</a>, <a class='category' href='/writings/tags/functional-programming/'>functional-programming</a>, <a class='category' href='/writings/tags/haskell/'>haskell</a>


</div>
	
</div></article>


    <article class="post">
	<h1 class="title"><a href="/writings/2012/11/30/monads-in-small-bites-part-i-functors/">Monads in Small Bites - Part I - Functors</a></h1>
	<div class="entry-content">
		<p>Today I join the already bloated group of people who wrote monad tutorials. It&#8217;s a bit of a ritual, really.</p>

<p>Different than most tutorials though I aim to take a different approach. The good news is that I won&#8217;t be comparing monads to burritos :)</p>

<p>People say one needs to have his/her own epiphany in order to understand Monads and reading explanations from others is of little help. My goal is to disprove that.</p>

<p>To that end, this tutorial will be split in four parts:</p>

<ul>
<li><p>Part I   - Functors (this post)</p></li>
<li><p><a href="/writings/2012/12/02/monads-in-small-bites-part-ii-applicative-functors/">Part II  - Applicative Functors</a></p></li>
<li><p><a href="/writings/2012/12/05/monads-in-small-bites-part-iii-monoids/">Part III - Monoids</a></p></li>
<li><p><a href="/writings/2012/12/08/monads-in-small-bites-part-iv-monads/">Part IV  - Monads</a></p></li>
</ul>


<p>You might want to bookmark this page - once the other parts are up, I&#8217;ll update the list above with the links to them.</p>

<h3>Before we start</h3>

<p>I know what you&#8217;re thinking: Do I really need to know Applicative Functors just to grasp Monads?</p>

<p>Well, no. However, I found that gradually building your knowledge from Parts I, II and III will allow you to fully grasp monads without the need for burritos or elephants.</p>

<p>You should also be familiar with a functional programming language. Any language should be fine but you&#8217;ll get the most out of this tutorial if you&#8217;re familiar with Haskell and/or Clojure.</p>

<p>If you&#8217;re not familiar with Clojure, fear not - Clojure is a small language and the code snippets should still make sense if you put your mind to it - they&#8217;re all short and sweet. I also encourage you to re-implement the examples in your language of choice to gain a deeper understanding on the subject.</p>

<p>Ready then? Let&#8217;s dive in.</p>

<h2>Just enough Haskell</h2>

<p>This is not a Haskell tutorial but trust me when I tell you that learning just enough about its type signatures will make all the difference in the world in understanding the concepts I&#8217;m about to present.</p>

<p>Although I&#8217;ll be using a little bit of Haskell syntax, I&#8217;ll also provide implementations in Clojure. They are in order so you should be able to paste all code sample in the REPL and follow along if you wish.</p>

<h3>Type signatures</h3>

<p>I&#8217;ll make this quick. Say you have a function called <code>mk-vec</code> that creates a 2D vector with <code>x</code> and <code>y</code> coordinates. Such function could easily be coded in Clojure like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">defn </span><span class="nv">mk-vec</span> <span class="p">[</span><span class="nv">x</span> <span class="nv">y</span><span class="p">]</span>
</span><span class='line'>  <span class="p">{</span><span class="nv">:x</span> <span class="nv">x</span> <span class="nv">:y</span> <span class="nv">y</span><span class="p">})</span>
</span><span class='line'>
</span><span class='line'><span class="c1">;; using it</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">my-vec</span> <span class="p">(</span><span class="nf">mk-vec</span> <span class="mi">10</span> <span class="mi">15</span><span class="p">))</span>
</span><span class='line'><span class="p">(</span><span class="nf">:x</span> <span class="nv">my-vec</span><span class="p">)</span> <span class="c1">;; 10</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see, this function takes two arguments - x and y - and returns a map - or hash if you come from Ruby - that wraps those values in it, providing an easy way to retrieve them.</p>

<p>Now if this function had been implemented in haskell this would be its type signature - read the comments:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='haskell'><span class='line'><span class="kr">import</span> <span class="k">qualified</span> <span class="nn">Data.Map</span> <span class="k">as</span> <span class="n">Map</span> <span class="c1">-- just giving Data.Map an alias</span>
</span><span class='line'><span class="nf">mkVec</span> <span class="ow">::</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Map</span><span class="o">.</span><span class="kt">Map</span> <span class="p">[</span><span class="kt">Char</span><span class="p">]</span> <span class="n">a</span> <span class="c1">-- this is the type signature</span>
</span><span class='line'>
</span><span class='line'><span class="nf">mkVec</span> <span class="n">x</span> <span class="n">y</span> <span class="ow">=</span> <span class="kt">Map</span><span class="o">.</span><span class="n">fromList</span> <span class="p">[(</span><span class="s">&quot;x&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="p">(</span><span class="s">&quot;y&quot;</span><span class="p">,</span> <span class="n">y</span><span class="p">)]</span> <span class="c1">-- this is the implementation. You can ignore this part.</span>
</span><span class='line'>
</span><span class='line'><span class="c1">-- using it</span>
</span><span class='line'><span class="nf">myVec</span> <span class="ow">=</span> <span class="n">mkVec</span> <span class="mi">10</span> <span class="mi">15</span>
</span><span class='line'><span class="kt">Map</span><span class="o">.</span><span class="n">lookup</span> <span class="s">&quot;x&quot;</span> <span class="n">myVec</span> <span class="c1">-- Just 10 </span>
</span><span class='line'><span class="c1">--</span>
</span><span class='line'><span class="c1">-- ignore the actual value that is returned. Read it as 10 for now.</span>
</span></code></pre></td></tr></table></div></figure>


<p>Whatever comes after the <code>::</code> is part of the function type signature. Read it like this:</p>

<blockquote><p>This is a function that receives two arguments of type <code>a</code> - which means any type - and returns a Map of key/value pairs where the key is of type <code>[Char]</code> - technically a list of <code>Char</code> values but for all effects and purposes just read it as <code>String</code> - and the value is of type <code>a</code> - the same type as its arguments.</p></blockquote>

<p>It might help to see the type signature in this light:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='haskell'><span class='line'><span class="nf">mkVec</span> <span class="ow">::</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="p">(</span><span class="kt">Map</span><span class="o">.</span><span class="kt">Map</span> <span class="p">[</span><span class="kt">Char</span><span class="p">]</span> <span class="n">a</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>It highlights the return value in parenthesis.</p>

<p>Now let&#8217;s have a look at a built in function, <code>*</code>. As you know, it performs multiplication and this is its type signature:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='haskell'><span class='line'><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="ow">::</span> <span class="kt">Num</span> <span class="n">a</span> <span class="ow">=&gt;</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">a</span>
</span></code></pre></td></tr></table></div></figure>


<p>Can you guess now what it means? I&#8217;m sure you can. There&#8217;s one small difference though: this function has a type constraint - it&#8217;s that <strong>Num a => &#8230;</strong> part of the signature. Read it like this:</p>

<blockquote><p>This is a function that receives two arguments of type <code>a</code> and returns a value of the same type, as long as the type of <code>a</code> is an instance of <code>Num</code></p></blockquote>

<p>And that&#8217;s it for now. Read it again to make sure it&#8217;s fresh in your mind and then continue.</p>

<p>As we encounter more type signatures, I&#8217;ll walk you through each one of them - but if you got it up until now, you&#8217;ll easily grasp the other type signatures.</p>

<h3>Functors</h3>

<p>In a nutshell Functors are things that can be mapped over.</p>

<p>Haskell defines Functors like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='haskell'><span class='line'><span class="kr">class</span> <span class="kt">Functor</span> <span class="n">f</span> <span class="kr">where</span>
</span><span class='line'>  <span class="n">fmap</span> <span class="ow">::</span> <span class="p">(</span><span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">b</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="n">f</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">f</span> <span class="n">b</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&#8217;s dissect that type signature:</p>

<blockquote><p><strong>fmap</strong> is a function that receives two arguments: the first is a function that receives an argument of type <code>a</code> and returns a value of type <code>b</code> and the second is a Functor that contains a value of type <code>a</code> - represented by <code>f a</code>. The result of calling <code>fmap</code> is a Functor of same type - <code>f</code> - containing a value of type <strong>b</strong>, which is the result of applying the function to <strong>a</strong>.</p></blockquote>

<p>Too much? Let&#8217;s have a look at an example: the <strong>List</strong> Functor.</p>

<p>If we rewrite the <code>fmap</code> type signature as if it only worked on lists, this is what we&#8217;d come up with:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='haskell'><span class='line'>  <span class="n">fmap</span> <span class="ow">::</span> <span class="p">(</span><span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">b</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="ow">-&gt;</span> <span class="p">[</span><span class="n">b</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>This new type signature allows us to rewrite that last definition:</p>

<blockquote><p><strong>fmap</strong> is a function that receives two arguments: the first is a function that receives an argument of type <code>a</code> and returns a value of type <code>b</code> and the second is a List of zero or more values of type <strong>a</strong>. The result of calling <code>fmap</code> is a List of zero or more values of type <strong>b</strong>, each of which is the result of applying the function to each <code>a</code> element.</p></blockquote>

<p>Does this sound familiar to you? It should, because this is essentially what the <code>map</code> function available in most functional-<em>ish</em> languages does! It takes a function and a list, applies the function to every element in the list while putting the results into a new list, finally returning it.</p>

<p>In fact, the <code>fmap</code> implementation of the List Functor from Haskell is implemented in terms of <code>map</code>.</p>

<p>Let&#8217;s see how that could be done in Clojure. I&#8217;ll use <a href="http://clojure.org/protocols">protocols</a> and <a href="http://clojure.org/datatypes">records</a> but they are not strictly required for this.</p>

<p>Here&#8217;s our Functor protocol:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">defprotocol</span> <span class="nv">Functor</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">fmap</span> <span class="p">[</span><span class="nv">functor</span> <span class="nv">f</span><span class="p">]</span> <span class="s">&quot;Maps fn over the functor f&quot;</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>And now our List Functor:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">defrecord</span> <span class="nv">List</span> <span class="p">[</span><span class="nv">wrapped</span><span class="p">]</span>
</span><span class='line'>    <span class="nv">Functor</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">fmap</span> <span class="p">[</span><span class="nv">functor</span> <span class="nv">f</span><span class="p">]</span>
</span><span class='line'>        <span class="p">(</span><span class="nf">List</span><span class="o">.</span> <span class="p">(</span><span class="nb">map </span><span class="nv">f</span> <span class="p">(</span><span class="nf">:wrapped</span> <span class="nv">functor</span><span class="p">)))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>In the snippet above all we&#8217;re saying is that the List record must satisfy the Functor protocol, which makes sense. <code>fmap</code> then is responsible for <em>unwrapping</em> the value contained in the list functor and <em>mapping</em> <code>f</code> over it.</p>

<p>Give it a go!</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">my-list-functor</span> <span class="p">(</span><span class="nf">List</span><span class="o">.</span> <span class="p">[</span><span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span><span class="p">]))</span> <span class="c1">;; List{:wrapped (1 2 3)}</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">fmap</span> <span class="nv">my-list-functor</span> <span class="o">#</span><span class="p">(</span><span class="nv">*</span> <span class="mi">2</span> <span class="nv">%</span><span class="p">))</span> <span class="c1">;; List{:wrapped (2 4 6)}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can now <code>map</code> arbitrary functions over the values <code>wrapped</code> in a Functor! Awesome!</p>

<blockquote><p><strong>Note</strong>: In our Clojure version of the List Functor, it is implemented as a Record that wraps a primitive Clojure list/vector - <code>[]</code>. As I mentioned this is not necessary but I chose to do it here to explicitly show the relationship with the Haskell types.</p></blockquote>

<h3>Don&#8217;t break the law</h3>

<p>Now that we got a feel for what Functors are, it&#8217;s worth noting that they must obey a few laws to be considered full-fledged Functors.</p>

<h4>Identity</h4>

<blockquote><p>Mapping an identity function over a Functor is the same as applying identity to the Functor itself</p></blockquote>

<p>This is how Haskell puts this law:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='haskell'><span class='line'><span class="nf">fmap</span> <span class="n">id</span> <span class="n">functor</span> <span class="ow">=</span> <span class="n">id</span> <span class="n">functor</span>
</span></code></pre></td></tr></table></div></figure>


<p>Translating that to Clojure:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="c1">;;This...</span>
</span><span class='line'><span class="p">(</span><span class="nf">fmap</span> <span class="nv">my-list-functor</span> <span class="nv">identity</span><span class="p">)</span> <span class="c1">;; List{:wrapped (1 2 3)}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">;;is the same as:</span>
</span><span class='line'><span class="p">(</span><span class="nb">identity </span><span class="nv">my-list-functor</span><span class="p">)</span> <span class="c1">;; List{:wrapped [1 2 3]}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Composition</h4>

<blockquote><p>If you compose the functions <code>f</code> and <code>g</code> and map the resulting function over the Functor, that is the same as first mapping <code>g</code> over the Functor and <code>then</code> mapping <code>f</code> over the resulting Functor.</p></blockquote>

<p>From the description you can see that this law involves <a href="http://en.wikipedia.org/wiki/Function_composition">function composition</a>. In Clojure, that&#8217;s achieved with the <a href="http://clojuredocs.org/clojure_core/clojure.core/comp">comp</a> function.</p>

<p>Again, let&#8217;s see how this law is defined in Haskell:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='haskell'><span class='line'><span class="nf">fmap</span> <span class="p">(</span><span class="n">f</span> <span class="o">.</span> <span class="n">g</span><span class="p">)</span> <span class="n">functor</span> <span class="ow">=</span> <span class="n">fmap</span> <span class="n">f</span> <span class="p">(</span><span class="n">fmap</span> <span class="n">g</span> <span class="n">functor</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p><strong>Note</strong>: The <code>.</code> operator denotes function composition in Haskell</p></blockquote>

<p>And the proof in Clojure:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">f</span> <span class="o">#</span><span class="p">(</span><span class="nv">+</span> <span class="mi">10</span> <span class="nv">%</span><span class="p">))</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">g</span> <span class="o">#</span><span class="p">(</span><span class="nv">*</span> <span class="mi">2</span> <span class="nv">%</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="c1">;; given the above, this...</span>
</span><span class='line'><span class="p">(</span><span class="nf">fmap</span> <span class="nv">my-list-functor</span> <span class="p">(</span><span class="nb">comp </span> <span class="nv">f</span> <span class="nv">g</span><span class="p">))</span> <span class="c1">;; List{:wrapped (12 14 16)}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">;; is the same as:</span>
</span><span class='line'><span class="p">(</span><span class="nb">-&gt; </span><span class="nv">my-list-functor</span> <span class="p">(</span><span class="nf">fmap</span> <span class="nv">g</span><span class="p">)</span> <span class="p">(</span><span class="nf">fmap</span> <span class="nv">f</span><span class="p">))</span> <span class="c1">;; List{:wrapped (12 14 16)}</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p><strong>Note</strong>: make sure you&#8217;re familiar with <a href="http://clojuredocs.org/clojure_core/clojure.core/-%3E">Clojure&#8217;s threading macro: <strong>-></strong> </a>. I&#8217;ll be using it in most code snippets.</p></blockquote>

<p>Nice! All laws hold so we can sleep peacefully in the knowledge that our Functor works as expected.</p>

<p>Now go get a drink and stay tuned for <a href="/writings/2012/12/02/monads-in-small-bites-part-ii-applicative-functors/">Part II</a>, where I&#8217;ll introduce <em>Applicative Functors</em>.</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2012-11-30T01:06:00+11:00" pubdate data-updated="true">Nov 30<span>th</span>, 2012</time></div>
	<div class="tags">


	<a class='category' href='/writings/tags/clojure/'>clojure</a>, <a class='category' href='/writings/tags/functional-programming/'>functional-programming</a>, <a class='category' href='/writings/tags/haskell/'>haskell</a>


</div>
	
</div></article>


    <article class="post">
	<h1 class="title"><a href="/writings/2012/11/05/this-is-was-we-built-in-24-hours/">This Is What We Built in 24 Hours</a></h1>
	<div class="entry-content">
		<p>Last week our current client - <a href="http://ninemsn.com.au/">ninemsn</a> - ran the 3rd edition of their HackDay.</p>

<p>It&#8217;s akin to Atlassian&#8217;s <a href="http://www.atlassian.com/shipit-day">ShipIt</a> days so if you&#8217;re not familiar with the concept, you should check their page but here&#8217;s the gist:</p>

<ul>
<li><p>We&#8217;re given 24 hours to work on whatever we like as long as it&#8217;s related somehow to the business</p></li>
<li><p>We&#8217;re also free to use any technology we want</p></li>
</ul>


<p>The team consisted of <a href="https://twitter.com/romainprieto">@romainprieto</a>, Pranav Raja, <a href="https://twitter.com/thepaddedcell">@thepaddedcell</a>, <a href="https://twitter.com/stewgleadow">@stewgleadow</a> and myself (<a href="https://twitter.com/leonardo_borges">@leonardo_borges</a>).</p>

<h3>The idea: Cool story, bro!</h3>

<p><a href="https://twitter.com/romainprieto">@romainprieto</a> came up with it:</p>

<ul>
<li>A mobile app that could scan QR codes on a printed <a href="http://www.atlassian.com/software/jira/overview/">JIRA</a> story card and provide features such as assigning a card to yourself, moving it between columns and adding comments to it.</li>
</ul>


<p>This is a common need. Most people will manage their stories in some sort of software such as JIRA. But it&#8217;s also common to have a physical story wall.</p>

<p>The problem then is keeping them in sync. It&#8217;s all too common for people to move the cards on the well and forget all about JIRA.</p>

<p>Well, not anymore. This is exactly what our HackDay project tackles.</p>

<p>In 24 hours, we built two native mobile applications - Android and iPhone - that are able to scan QR Codes printed on the story cards and, through integrating with the JIRA REST API, provide all the necessary functionality needed for:</p>

<ul>
<li>Assigning a story to yourself - whoever is logged in to the app</li>
<li>Moving the story between states - e.g.: In Analysis, Resolve Issue, Reopen Issue etc&#8230;</li>
<li>Adding comments to a given story</li>
</ul>


<p>All code is <a href="https://github.com/ninemsn/cool-story">open source and on github</a>. <a href="https://github.com/ninemsn/cool-story">Check it out</a>! - and bear in mind this was written in 24 hours&#8230; ;)</p>

<p>We didn&#8217;t stop there though. We actually finished early and had a couple of hours to spare so we shot a video - yes, a video!!! - about the app. I&#8217;m telling you, this is Hollywood quality:</p>

<iframe width="560" height="315" src="http://www.youtube.com/embed/jzhY4JHDowI" frameborder="0" allowfullscreen></iframe>


<p>Also, checkout some screenshots of the Android version:</p>

<p>
<div class="gallery">
    <a rel="gallery1" href="/writings/assets/images/posts/cool-story-1.png" class="fancybox hoverZoomLink">
        <img src="/writings/assets/images/posts/cool-story-1.png" width="120" height="213"/>
    </a>
    <a rel="gallery1" href="/writings/assets/images/posts/cool-story-2.png" class="fancybox hoverZoomLink">
        <img src="/writings/assets/images/posts/cool-story-2.png" width="120" height="213"/>
    </a>
    <a rel="gallery1" href="/writings/assets/images/posts/cool-story-3.png" class="fancybox hoverZoomLink">
        <img src="/writings/assets/images/posts/cool-story-3.png" width="120" height="213"/>
    </a>
    <a rel="gallery1" href="/writings/assets/images/posts/cool-story-4.png" class="fancybox hoverZoomLink">
        <img src="/writings/assets/images/posts/cool-story-4.png" width="120" height="213"/>
    </a>
    <div class="clear"></div>
</div>

<script src="/writings/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
    $('.fancybox').fancybox();
})(jQuery);
</script>

Enjoy! :)


		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2012-11-05T11:12:00+11:00" pubdate data-updated="true">Nov 5<span>th</span>, 2012</time></div>
	<div class="tags">


	<a class='category' href='/writings/tags/android/'>android</a>, <a class='category' href='/writings/tags/ios/'>ios</a>, <a class='category' href='/writings/tags/mobile/'>mobile</a>


</div>
	
</div></article>


    <article class="post">
	<h1 class="title"><a href="/writings/2012/09/10/clojure-leiningen-heroku-aot-compilation-gotchas/">Clojure, Leiningen 2 and Heroku: AOT Compilation Gotchas</a></h1>
	<div class="entry-content">
		<p>Recently I upgraded the <a href="http://clojure.org/">clojure</a> project I&#8217;m working on to <a href="http://leiningen.org/">Leiningen 2</a> in order to start using <a href="https://github.com/clojure/tools.nrepl">nrepl</a> - since <a href="https://github.com/technomancy/swank-clojure">swank-clojure</a> is now <a href="http://technomancy.us/163">deprecated</a>. Little did I know this would lead me to a small debugging adventure.</p>

<h3>Heroku</h3>

<p>I use <a href="http://www.heroku.com/">Heroku</a> as my deployment platform and my project had been running on it for a few weeks without any
issues. I also use Heroku&#8217;s PostgreSQL solution.</p>

<p>However, by upgrading to Leiningen 2, my project started throwing some weird exceptions during deployment -  it couldn&#8217;t connect to my database any longer. Everything was fine on my local environment though.</p>

<p>Upon inspecting the deployment logs on Heroku, I realized that the <a href="https://github.com/heroku/heroku-buildpack-clojure">Heroku Clojure Buildpack</a> tries to perform <a href="http://clojure.org/compilation">Ahead of Time (AOT) compilation</a> if it identifies the project is running Leiningen 2.x</p>

<p>This means that after receiving a git push Heroku runs this command:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>lein with-profile production compile :all
</span></code></pre></td></tr></table></div></figure>


<p>At first this might seem harmless. But step back for a second and think about what this means for code that depends on environment variables.</p>

<h3>Case in point: Lobos</h3>

<p><a href="https://github.com/budu/lobos">Lobos</a> is a clojure library for manipulating database schemas akin <a href="http://api.rubyonrails.org/classes/ActiveRecord/Migration.html">ActiveRecord migrations</a> in Ruby land.</p>

<p>The <a href="https://github.com/budu/lobos#real-world-example">real-world</a> example on their github page recommends this code snippet for configuring a database connection:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">ns</span> <span class="nv">lobos</span><span class="o">.</span><span class="nv">config</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">:use</span> <span class="nv">lobos</span><span class="o">.</span><span class="nv">connectivity</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">db</span>
</span><span class='line'>  <span class="p">{</span><span class="nv">:classname</span> <span class="s">&quot;org.postgresql.Driver&quot;</span>
</span><span class='line'>   <span class="nv">:subprotocol</span> <span class="s">&quot;postgresql&quot;</span>
</span><span class='line'>   <span class="nv">:user</span> <span class="s">&quot;test&quot;</span>
</span><span class='line'>   <span class="nv">:password</span> <span class="s">&quot;test123&quot;</span>
</span><span class='line'>   <span class="nv">:subname</span> <span class="s">&quot;//localhost:5432/test&quot;</span><span class="p">})</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">open-global</span> <span class="nv">db</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>More often than not this isn&#8217;t ideal. You&#8217;ll probably want to customise your database configuration based on environment variables. Something along these lines:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">ns</span> <span class="nv">lobos</span><span class="o">.</span><span class="nv">config</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">:use</span> <span class="nv">lobos</span><span class="o">.</span><span class="nv">connectivity</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">db</span>
</span><span class='line'>     <span class="p">{</span><span class="nv">:classname</span> <span class="s">&quot;org.postgresql.Driver&quot;</span>
</span><span class='line'>      <span class="nv">:subprotocol</span> <span class="s">&quot;postgresql&quot;</span>
</span><span class='line'>      <span class="nv">:user</span> <span class="p">(</span><span class="nf">System/getenv</span> <span class="s">&quot;DB_USER&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="nv">:password</span> <span class="p">(</span><span class="nf">System/getenv</span> <span class="s">&quot;DB_PASSWORD&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="nv">:subname</span> <span class="p">(</span><span class="nf">System/getenv</span> <span class="s">&quot;DATABASE_URL&quot;</span><span class="p">)})</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">open-global</span> <span class="nv">db</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>And you&#8217;re good to go - until Heroku decides to AOT compile your code.</p>

<h3>Compilation</h3>

<p>The Clojure compilation process caught me by surprise. As stated by <a href="https://twitter.com/richhickey">Rich Hickey</a> on <a href="http://clojure-log.n01se.net/date/2008-11-12.html#16:07">this IRC log entry</a>, &#8220;a side effect of compiling Clojure code is loading the namespaces in order to make macros and functions they use available&#8221;.</p>

<p>This means that during compilation, any top level function calls - such as <code>(open-global db)</code> from above - will get executed. The same applies to macros that expand to top-level function calls.</p>

<p>If said function call has no side effects, you&#8217;re probably ok.</p>

<p>The trouble with <em>open-global</em> though is that it effectively attempts a connection to the database!</p>

<p><strong>BAM!</strong></p>

<p>On Heroku the environment variables you rely on - such as <em>DATABASE_URL</em> - aren&#8217;t available on compile time meaning a connection will be attempted to an empty url. <em>All sorts of badness</em>.</p>

<p>After having understood why the compilation process was effectively executing top level function calls, I then wrapped that call to <em>open-global</em> in a function declaration:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">defn </span><span class="nv">init</span> <span class="p">[]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">open-global</span> <span class="p">(</span><span class="nf">db</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>


<p>This will prevent eager evaulation during compilation since all <code>defn</code> does is bind the given function body to a <em>var</em>.</p>

<p>Then, in the code that needs migrations to happen - such as in my <a href="https://github.com/marick/Midje">midje</a> tests setup - I initialize the database like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">background</span>
</span><span class='line'> <span class="p">(</span><span class="nf">before</span> <span class="nv">:contents</span> <span class="p">(</span><span class="nf">lobos</span><span class="o">.</span><span class="nv">config/init</span><span class="p">))</span>
</span><span class='line'> <span class="p">(</span><span class="nf">before</span> <span class="nv">:facts</span> <span class="p">(</span><span class="nf">migrate</span><span class="p">)</span>
</span><span class='line'>         <span class="nv">:after</span> <span class="p">(</span><span class="nf">rollback</span> <span class="nv">:all</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>


<p>I spent some time in the #clojure IRC channel on freenode and it is accepted that top level function calls should be avoided anyway - especially if you&#8217;re dealing with side effects.</p>

<p>I also applied the same principle to other initialization code I have such as the configuration for <a href="http://sqlkorma.com/">Korma</a>.</p>

<h3>Happy ending?</h3>

<p>Not quite. After having spent quite some time to get to this point, this was the new error that was stealing my sleep:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Caused by: java.lang.NullPointerException
</span><span class='line'>    at java.util.concurrent.ConcurrentHashMap.hash<span class="o">(</span>ConcurrentHashMap.java:332<span class="o">)</span>
</span><span class='line'>    at java.util.concurrent.ConcurrentHashMap.get<span class="o">(</span>ConcurrentHashMap.java:987<span class="o">)</span>
</span><span class='line'>    at clojure.lang.Namespace.find<span class="o">(</span>Namespace.java:188<span class="o">)</span>
</span><span class='line'>    at clojure.core<span class="nv">$find_ns</span>.invoke<span class="o">(</span>core.clj:3659<span class="o">)</span>
</span><span class='line'>    at clojure.core<span class="nv">$the_ns</span>.invoke<span class="o">(</span>core.clj:3691<span class="o">)</span>
</span><span class='line'>    at clojure.core<span class="nv">$ns_name</span>.invoke<span class="o">(</span>core.clj:3698<span class="o">)</span>
</span><span class='line'>    at my_app.env__init.load<span class="o">(</span>Unknown Source<span class="o">)</span>
</span><span class='line'>    at my_app.env__init.&lt;clinit&gt;<span class="o">(</span>Unknown Source<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>This isn&#8217;t an unknown error. It basically means you&#8217;re trying to find a namespace that doesn&#8217;t exist. Or does it?</p>

<p>Once again this only happened if the code got compiled Ahead Of Time. Puzzling.</p>

<p>A couple of debugging hours later and I tracked it down to be a problem with <a href="https://github.com/malcolmsparks/clj-logging-config">clj-logging-config</a> - a logging configuration utility for clojure. This is the offending code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">ns</span> <span class="nv">my-app</span><span class="o">.</span><span class="nv">env</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">:use</span>
</span><span class='line'>    <span class="nv">clojure</span><span class="o">.</span><span class="nv">tools</span><span class="o">.</span><span class="nv">logging</span>
</span><span class='line'>    <span class="nv">clj-logging-config</span><span class="o">.</span><span class="nv">log4j</span><span class="p">))</span>
</span><span class='line'><span class="p">(</span><span class="nf">set-logger!</span><span class="p">)</span> <span class="c1">;; this call causes the exception</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>set-logger!</code> is a macro that makes use of the <strong>*ns*</strong> var. <strong>*ns*</strong> contains the current namespace and, due to what I&#8217;m assuming to be special semantics regarding this particular var, it shouldn&#8217;t be <a href="http://clojuredocs.org/clojure_core/clojure.core/unquote"><em>unquoted</em></a> within a macro - which is why it was failing in AOT mode.</p>

<p>I <a href="https://github.com/malcolmsparks/clj-logging-config/issues/15">opened an issue</a> in the clj-logging-config github page. I eventually forked the project and fixed the issue in <a href="https://github.com/malcolmsparks/clj-logging-config/pull/16">this pull request</a>. That was then <a href="https://github.com/malcolmsparks/clj-logging-config/commit/ec8a08535daad01eb9f23e92771b623b5902c8c9">merged last Friday</a>.</p>

<p>My code now works perfectly - regardless of AOT compilation.</p>

<h3>Final thoughts</h3>

<p>This was a nice little journey and I&#8217;m actually glad I went through it. I have a much better understanding of Clojure&#8217;s compilation process, worked out some quirks on Heroku and even got my first Clojure related open-source contribution accepted. Life is good.</p>

<p>Hopefully this will save other people a lot of time and effort debugging similar issues.</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2012-09-10T10:41:00+10:00" pubdate data-updated="true">Sep 10<span>th</span>, 2012</time></div>
	<div class="tags">


	<a class='category' href='/writings/tags/clojure/'>clojure</a>, <a class='category' href='/writings/tags/functional-programming/'>functional-programming</a>


</div>
	
</div></article>


    <article class="post">
	<h1 class="title"><a href="/writings/2012/08/23/sean-corfield-clojure-and-cfml-sitting-in-a-tree/">Sean Corfield: Clojure and CFML Sitting in a Tree</a></h1>
	<div class="entry-content">
		<p>Last night I attended the Adobe User Group here in Sydney. That might strike some of you as a big surprise
given my relationship with Adobe is pretty much limited to fiddling with Photoshop/Lightroom to get my photos looking nice.</p>

<p>However the reason for which I attended the meetup is that <a href="https://twitter.com/seancorfield">Sean Corfield</a> - a prolific member of the Clojure community - gave a presentation on how he introduced and migrated most of his backend code at <a href="http://worldsingles.com/ws2010/index.cfm">World Singles</a> from <a href="http://en.wikipedia.org/wiki/ColdFusion_Markup_Language">CFML</a> to <a href="http://clojure.org/">Clojure</a> - hence my interest.</p>

<p>What follows is a mix of my own notes and what I could remember from the slides:</p>

<h3>Going faster</h3>

<p>The original platform was built in CFML between 2001 and 2008. It was essentially monolithic procedural code. It was rewritten in 2009 - when they introduced OO and a new version of CFML</p>

<h3>Brief Stats</h3>

<ul>
<li>3 million members</li>
<li>1 million emails sent every day</li>
<li>2k concurrent users 24x7, on average</li>
</ul>


<h3>Clojure and WorldSingles</h3>

<ul>
<li>Tried .NET - ran into all sorts of trouble. Didn&#8217;t work well in production.</li>
<li>Tried Scala - Memory leaks in the built-in actor library were a deal breaker. The type system also wasn&#8217;t a good cultural fit.</li>
<li>Evaluated Clojure in 2010 - seemed like a good language to squeeze performance out of lower level components</li>
<li>Clojure version released in production in 2011

<ul>
<li>Rewrote remaining Scala Code</li>
<li>6.3k LOC - 1.5k Tests LOC</li>
<li>equivalent to 4x the CFML LOC</li>
<li>Clojure is essentially used in the model (as in MVC)</li>
</ul>
</li>
</ul>


<h3>Why add Clojure?</h3>

<ul>
<li>It&#8217;s fast - compiles down to JVM bytecode (and it&#8217;s faster than CFML)</li>
<li>Immutability (automatic thread safety)

<ul>
<li>they found several thread safety bugs in the third party ColdFusion libraries being used</li>
</ul>
</li>
<li>Built-in concurrency / parallelism support - <a href="http://clojuredocs.org/clojure_core/clojure.core/future">future</a>, <a href="http://clojuredocs.org/clojure_core/clojure.core/pmap">pmap</a>, <a href="http://clojuredocs.org/clojure_core/clojure.core/pvalues">pvalues</a> etc.</li>
<li>Lazy sequences - being able to work with potentially ininite collections without bringing your server down.</li>
<li>All high quality, production ready Java libraries easily accessible via <a href="http://clojure.org/java_interop">java interop</a>.</li>
</ul>


<h3>What do they use it for?</h3>

<ul>
<li>Email

<ul>
<li>html generation &amp; sending</li>
<li>tracking &amp; log file analysis</li>
</ul>
</li>
<li>Geolocation (rest/json)</li>
<li>i18n</li>
<li>Reporting (parallel queries) - he showed a bit of this code. Heavy use of <a href="http://clojuredocs.org/clojure_core/clojure.core/future">futures</a> + <a href="http://clojuredocs.org/clojure_core/clojure.core/deref">deref</a></li>
<li>Search engine integration (json/xml)

<ul>
<li>This breaks down to two Clojure components:</li>
<li>One feeds the search engine based on changes to the users profiles</li>
<li>The other then runs against the search engine 24x7 trying to find new matches for users</li>
</ul>
</li>
<li>(lightweight?) Persistence layer

<ul>
<li>no ORM - thin framework over sql instead</li>
<li>Same interface for both Mysql &amp; MongoDB</li>
<li>MongoDB being used after hitting performance issues in Mysql</li>
</ul>
</li>
</ul>


<h3>Clojure ecosystem/community</h3>

<p>Having an active Community is crucial for language adoption and the clojure community got this right:</p>

<ul>
<li>Community

<ul>
<li>6700 developers on the <a href="https://groups.google.com/forum/?fromgroups#!forum/clojure">mailing list</a></li>
<li>~300 developers on IRC 24x7</li>
</ul>
</li>
<li>Active library development

<ul>
<li>#23 language on Github</li>
<li>Over 7k projects on github</li>
<li>Nearly 2k libs on <a href="https://clojars.org/">Clojars</a></li>
</ul>
</li>
</ul>


<h3>The Future</h3>

<ul>
<li>Looking into <a href="https://github.com/nathanmarz/cascalog">Cascalog</a> for big data processing</li>
<li>All new back-end/model code written in Clojure</li>
<li>Views/Controllers will remain in CFML

<ul>
<li>This ties up with Sean&#8217;s answer to &#8216;What would you not use Clojure for?&#8217;</li>
<li>He mentioned HTML rendering as the major reason. You can&#8217;t hand <a href="https://github.com/weavejester/hiccup">hiccup</a> code to a designer.</li>
<li>Similarly, while designers can work on <a href="https://github.com/cgrand/enlive">Enlive</a> templates, updating the dynamic bits in Clojure can be cumbersome.</li>
</ul>
</li>
</ul>


<h3>Summary</h3>

<p>It was great to hear the many good things Sean had to say about Clojure. WorldSingles seem pretty happy with the decision of migration their heavy-lifting code to it and hopefully these slide notes will give you some insight into the sort of things Clojure is good at.</p>

<p><del>Sean is likely to put his slides up somewhere so I&#8217;ll link to it as soon as I have it.</del> <a href="http://corfield.org/articles/WorldSinglesWeb.pdf">Here they are.</a></p>

<p>If you want to know more about Clojure and be involved in the community, you should come to the next <a href="http://www.meetup.com/clj-syd/">clj-syd meetup</a>.</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2012-08-23T00:03:00+10:00" pubdate data-updated="true">Aug 23<span>rd</span>, 2012</time></div>
	<div class="tags">


	<a class='category' href='/writings/tags/clj-syd/'>clj-syd</a>, <a class='category' href='/writings/tags/clojure/'>clojure</a>, <a class='category' href='/writings/tags/functional-programming/'>functional-programming</a>


</div>
	
</div></article>


    <article class="post">
	<h1 class="title"><a href="/writings/2012/05/03/build-automation-with-xcode-4-dot-3-kif-and-jenkins/">Build Automation With XCode 4.3, KIF and Jenkins</a></h1>
	<div class="entry-content">
		<p><strong>UPDATE:</strong> As pointed to me in <a href="http://www.leonardoborges.com/writings/2012/05/03/build-automation-with-xcode-4-dot-3-kif-and-jenkins/#comment-703288043">this commment</a>, sym links aren&#8217;t necessary for Waxsim anymore. Check <a href="https://github.com/jonathanpenn/WaxSim">Jonathan Penn&#8217;s fork on github</a>.</p>

<hr />

<p>After coming back from my holidays in China - which were awesome - I had no downtime at ThoughtWorks and started at a brand new client/project - a much needed change from what I had been working on lately.</p>

<p>It&#8217;s an iOS project, more specifically an iPad app and that&#8217;s pretty much all I can tell you about it. I will however tell you how my first few days in the project have been so far.</p>

<p>Being a brand new project I wanted to get our <a href="http://en.wikipedia.org/wiki/Continuous_integration">CI</a> environment up and running as fast as possible - after all the project has only a couple of tests now. For context, here&#8217;s our setup:</p>

<ul>
<li>XCode 4.3</li>
<li><a href="https://github.com/gabriel/gh-unit">GHUnit</a> (I&#8217;m not gonna talk too much about it since this was the easy part - their docs are pretty decent)</li>
<li><a href="https://github.com/square/KIF">KIF</a> (for UI tests)</li>
<li><a href="http://jenkins-ci.org/">Jenkins</a></li>
<li><a href="https://github.com/square/waxsim">WaxSim</a> (Hack to get the iPhone Simulator to run on the command line)</li>
</ul>


<p>In most environments I had worked so far - Java, Ruby, Clojure etc.. - running acceptance tests from the command line is a given and so is integrating that into your build system.</p>

<p>Well, that&#8217;s just not the case with iOS projects. These tasks can be a real pain and take a while to complete. Here&#8217;s what I had to do:</p>

<h3>On your development Mac</h3>

<p>I&#8217;m assuming here you have an XCode project with at least one KIF test and that it builds successfully from the GUI, when you hit play. Now we can move on to run the tests from the command line.</p>

<p>This is the script I&#8217;m using to run my KIF tests. I call it <code>RunKIF.sh</code> and  will walk you through it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/bin/bash</span>
</span><span class='line'>
</span><span class='line'>killall <span class="s2">&quot;iPhone Simulator&quot;</span>
</span><span class='line'>rm /tmp/KIF-*
</span><span class='line'>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;Build the &quot;</span>UI Tests<span class="s2">&quot; target to run in the simulator&quot;</span>
</span><span class='line'>xcodebuild -target <span class="s2">&quot;UI Tests&quot;</span> -configuration Release -sdk iphonesimulator clean build
</span><span class='line'>
</span><span class='line'><span class="nv">OUT_FILE</span><span class="o">=</span>/tmp/KIF-<span class="nv">$$</span>.out
</span><span class='line'><span class="c"># Run the app we just built in the simulator and send its output to a file</span>
</span><span class='line'><span class="c"># /path/to/MyApp.app should be the relative or absolute path to the application bundle that was built in the previous step</span>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;Running KIF tests&quot;</span>
</span><span class='line'>/tmp/waxsim -f <span class="s2">&quot;ipad&quot;</span> <span class="s2">&quot;build/Release-iphonesimulator/MyApp.app&quot;</span> &gt; <span class="nv">$OUT_FILE</span> 2&gt;&amp;1
</span><span class='line'>
</span><span class='line'><span class="c"># WaxSim hides the return value from the app, so to determine success we search for a &quot;no failures&quot; line</span>
</span><span class='line'>grep -q <span class="s2">&quot;TESTING FINISHED: 0 failures&quot;</span> <span class="nv">$OUT_FILE</span>
</span><span class='line'>
</span><span class='line'><span class="nv">success</span><span class="o">=</span><span class="sb">`</span><span class="nb">exec </span>grep -c <span class="s2">&quot;TESTING FINISHED: 0 failures&quot;</span> <span class="nv">$OUT_FILE</span><span class="sb">`</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c"># if there was a failure, show what waxsim was hiding and crucially return with a non-zero exit code</span>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$success&quot;</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span> <span class="o">]</span>
</span><span class='line'><span class="k">then </span>
</span><span class='line'><span class="k">    </span>cat <span class="nv">$OUT_FILE</span>
</span><span class='line'>    <span class="nb">echo</span> <span class="s2">&quot;===========================================&quot;</span>
</span><span class='line'>    <span class="nb">echo</span> <span class="s2">&quot;GUI Tests failed&quot;</span>
</span><span class='line'>    <span class="nb">echo</span> <span class="s2">&quot;===========================================&quot;</span>
</span><span class='line'>    <span class="nb">exit </span>1
</span><span class='line'><span class="k">else</span>
</span><span class='line'><span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;===========================================&quot;</span>
</span><span class='line'>    <span class="nb">echo</span> <span class="s2">&quot;GUI Tests passed&quot;</span>
</span><span class='line'>    <span class="nb">echo</span> <span class="s2">&quot;===========================================&quot;</span>
</span><span class='line'><span class="k">fi</span>
</span></code></pre></td></tr></table></div></figure>


<p>You&#8217;ll notice there are mainly two things happening in this script:</p>

<ul>
<li>It runs xcodebuild to build the target against which your tests will run</li>
<li>uses WaxSim to finally run your tests</li>
</ul>


<p>To get the building step to work, despite what KIF&#8217;s documentation DOESN&#8217;T tell you, you need to add KIF as a target dependency to your KIF Tests target. <a href="http://stackoverflow.com/questions/10000600/build-error-on-zapp-when-running-iphone-app-with-kif-testsuites">This SO thread</a> can walk you through it.</p>

<p>Now on to the fun stuff!
For some reason I didn&#8217;t have the time to dig into, WaxSim seems to expect XCode to be under <code>/Developer/</code> on your Mac.</p>

<p>The problem is that since Apple started distributing Xcode through the AppStore, it now lives under <code>/Applications/Xcode.app/Contents/Developer/</code>. Bam! This can cause all sorts of issues when building both WaxSim and your project. So if you see weird error messages complaining about not being able to find <code>DevToolsFoundation.framework</code> and the like, these sym links will probably fix things for you:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo ln -s /Applications/Xcode.app/Contents/Developer/ /Developer
</span><span class='line'>sudo ln -s /Applications/Xcode.app/Contents/OtherFrameworks/DevToolsCore.framework /Developer/Library/PrivateFrameworks/
</span><span class='line'>sudo ln -s /Applications/Xcode.app/Contents/OtherFrameworks/DevToolsCParsing.framework /Developer/Library/PrivateFrameworks/
</span><span class='line'>sudo ln -s /Applications/Xcode.app/Contents/OtherFrameworks/DevToolsFoundation.framework /Developer/Library/PrivateFrameworks/
</span><span class='line'>sudo ln -s /Applications/Xcode.app/Contents/OtherFrameworks/DevToolsInterface.framework /Developer/Library/PrivateFrameworks/
</span><span class='line'>sudo ln -s /Applications/Xcode.app/Contents/OtherFrameworks/DevToolsKit.framework /Developer/Library/PrivateFrameworks/
</span><span class='line'>sudo ln -s /Applications/Xcode.app/Contents/OtherFrameworks/DevToolsRemoteClient.framework /Developer/Library/PrivateFrameworks/
</span><span class='line'>sudo ln -s /Applications/Xcode.app/Contents/OtherFrameworks/DevToolsSupport.framework /Developer/Library/PrivateFrameworks/
</span></code></pre></td></tr></table></div></figure>


<p>I know, right? Moving on.</p>

<p>By now you should be able to successfully run <code>RunKIF.sh</code> and get meaningful results from your test. Let&#8217;s configure our CI server now, shall we?</p>

<h3>On your CI Mac</h3>

<p>Depending on which state your build box is, you might need to create the same sym links I created in the previous section. So ssh into your build box and try to build your project from the command line:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>xcodebuild -target <span class="s2">&quot;UI Tests&quot;</span> -configuration Release -sdk iphonesimulator clean build
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>This time I&#8217;ll assume you already have Jenkins installed and running.</p>

<p>Your Jenkins server is probably running as the jenkins user. You need to change that. Jenkins has to be running within a Desktop session - that&#8217;s a requirement from WaxSim.
It needs an active desktop session in order to launch the simulator - and thus needs to run as a user who can login to your CI Mac.</p>

<p>If you installed Jenkins using Homebrew, here&#8217;s a plist you can use to specify which user jenkins should run as:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
</span><span class='line'><span class="cp">&lt;!DOCTYPE plist PUBLIC &quot;-//Apple//DTD PLIST 1.0//EN&quot; &quot;http://www.apple.com/DTDs/PropertyList-1.0.dtd&quot;&gt;</span>
</span><span class='line'><span class="nt">&lt;plist</span> <span class="na">version=</span><span class="s">&quot;1.0&quot;</span><span class="nt">&gt;</span>
</span><span class='line'><span class="nt">&lt;dict&gt;</span>
</span><span class='line'>    <span class="nt">&lt;key&gt;</span>Label<span class="nt">&lt;/key&gt;</span>
</span><span class='line'>    <span class="nt">&lt;string&gt;</span>Jenkins<span class="nt">&lt;/string&gt;</span>
</span><span class='line'>    <span class="nt">&lt;key&gt;</span>ProgramArguments<span class="nt">&lt;/key&gt;</span>
</span><span class='line'>    <span class="nt">&lt;array&gt;</span>
</span><span class='line'>    <span class="nt">&lt;string&gt;</span>/usr/bin/java<span class="nt">&lt;/string&gt;</span>
</span><span class='line'>    <span class="nt">&lt;string&gt;</span>-jar<span class="nt">&lt;/string&gt;</span>
</span><span class='line'>    <span class="nt">&lt;string&gt;</span>/usr/local/Cellar/jenkins/1.439/lib/jenkins.war<span class="nt">&lt;/string&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/array&gt;</span>
</span><span class='line'>    <span class="nt">&lt;key&gt;</span>RunAtLoad<span class="nt">&lt;/key&gt;</span>
</span><span class='line'>    <span class="nt">&lt;true/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;key&gt;</span>UserName<span class="nt">&lt;/key&gt;</span>
</span><span class='line'>    <span class="nt">&lt;string&gt;</span>UserWhoCanLogintoThisMac<span class="nt">&lt;/string&gt;</span>
</span><span class='line'><span class="nt">&lt;/dict&gt;</span>
</span><span class='line'><span class="nt">&lt;/plist&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then load the new plist:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>launchctl load -w  /Users/UserWhoCanLogintoThisMac/Library/LaunchAgents/org.jenkins-ci.plist
</span></code></pre></td></tr></table></div></figure>


<p>Don&#8217;t forget to enable automatic login on the CI Mac for the user Jenkins is using. Check <a href="http://www.tech-faq.com/how-to-re-enable-mac-os-x-automatic-login.html">this article</a> to learn how to do it.</p>

<p>Now we&#8217;re mostly done. Just go ahead and configure your project.</p>

<p>Add a build step of the type <code>Execute Shell</code> and provide <code>sh RunKIF.sh</code> as the command string. Trigger your build and everything should work as expected.</p>

<h3>Final thoughts</h3>

<p>Once I actually got these steps together to write this post, it didn&#8217;t look like much. But the amount of time I wasted finding out what had to be done to actually make this work is just insane.</p>

<p>I&#8217;m shocked at how much behind iOS development tools seem to be. It just shouldn&#8217;t take this much effort and time only to get some UI tests automated. So far I&#8217;m disappointed with the tooling around the Apple ecosystem and I really hope this improves sooner rather than later.</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2012-05-03T13:17:00+10:00" pubdate data-updated="true">May 3<span>rd</span>, 2012</time></div>
	<div class="tags">


	<a class='category' href='/writings/tags/ios/'>ios</a>, <a class='category' href='/writings/tags/ipad/'>ipad</a>, <a class='category' href='/writings/tags/iphone/'>iphone</a>


</div>
	
</div></article>


    <article class="post">
	<h1 class="title"><a href="/writings/2012/02/22/clj-syd-report-number-0/">Clj-syd Report #0</a></h1>
	<div class="entry-content">
		<p>Last night we held the first ever meetup for the <a href="http://groups.google.com/group/clj-syd">Sydney Clojure User Group</a>!</p>

<p>When I decided to start running the meetups I had no idea we&#8217;d end up with <strong>37</strong>
people on the first night! What a great turn out!</p>

<p>As for the content, here&#8217;s what you missed:</p>

<ul>
<li><strong>Running Clojure apps on Heroku</strong> - Lincoln Stoll (<a href="https://twitter.com/#!/lstoll">@lstoll</a>)</li>
</ul>


<p>Linc works for Heroku but ended up not spending a whole lot of time talking about
that - instead he showed us how  to build a simple web application using
<a href="https://github.com/weavejester/compojure/wiki">Compojure</a>, a small Clojure web framework.</p>

<p>He then evolved the example by implementing it using <a href="http://webnoir.org/">Noir</a> - yet another web
framework that builds on top of <a href="https://github.com/weavejester/compojure/wiki">Compojure</a>, adding some helpful macros.</p>

<p>To top it off, the UI was implemented in <a href="https://github.com/clojure/clojurescript">ClojureScript</a> - so that was all Clojure
from end to end!</p>

<ul>
<li><strong>Paredit (in Eclipse) for the IDE junkie</strong> - Matt Quail (<a href="https://twitter.com/#!/spudbean">@spudbean</a>)</li>
</ul>


<p>If you&#8217;re into lisps and use emacs - if not you <strong>should</strong> anyway - you learned to
love <a href="http://www.emacswiki.org/emacs/ParEdit">paredit</a>.</p>

<p>However, not everyone gets to write Clojure for a living and a lot of us end up in
some sort of IDE. If you&#8217;re in Java land, a popular choice is Eclipse and Matt showed
us how you can get the paredit goodness right there using the Eclipse plugin <a href="http://code.google.com/p/counterclockwise/">counterclockwise</a>.</p>

<ul>
<li><strong><a href="http://offbytwo.com/presentations/building-better-repl.pdf">Building a better Clojure REPL</a></strong> - Cosmin Sterejean (<a href="https://twitter.com/#!/offbytwo">@offbytwo</a>)</li>
</ul>


<p>Frustrated with the Clojure REPL? Wish you had more useful shortcuts? Decent line
editing? Saving that nice function you&#8217;ve been working on right from the REPL? Then
make sure you check out both the <a href="http://offbytwo.com/presentations/building-better-repl.pdf">presentation</a> and <a href="https://github.com/cosmin/IClojure">IClojure</a>, Cosmin&#8217;s
project.</p>

<p>Definetly worth a try.</p>

<ul>
<li><strong><a href="https://docs.google.com/open?id=0B-wuNsBziQXAZWZmMzdjMDQtYzM4Zi00NGNjLThhY2ItYTFhOTZkOTQ0OTBh">Where do I put my DependentStrategyTemplateAbstractFactory</a>?</strong> - Bayan Khalili</li>
</ul>


<p>Bayan was in one of our internal meetups. Some people raised the fact that we don&#8217;t
see a lot of the design patterns made popular by the <a href="http://amzn.to/wdq6Lr">GoF book</a> in languages such as Ruby, Python or Clojure
and the overall opinion is that in those languages, some of the problems these
patterns solve in, say, Java, simply don&#8217;t exist.</p>

<p>Bayan decided to dig up a few and show what&#8217;s the alternative in Clojure. Interesting
perspective.</p>

<h2>Want more?</h2>

<p>Join us on <a href="http://groups.google.com/group/clj-syd">Google Groups</a>, submit a talk proposal on the <a href="https://github.com/clj-syd/clj-syd/wiki">wiki</a> and RSVP to
the <a href="http://www.meetup.com/clj-syd/">next meetup</a>!</p>

<p>See you next time!</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2012-02-22T21:14:00+11:00" pubdate data-updated="true">Feb 22<span>nd</span>, 2012</time></div>
	<div class="tags">


	<a class='category' href='/writings/tags/clj-syd/'>clj-syd</a>, <a class='category' href='/writings/tags/clojure/'>clojure</a>


</div>
	
</div></article>

<nav id="pagenavi">
    
        <a href="/writings/writings/page/2/" class="prev">Prev</a>
    
    
        <a href="/writings/writings/page/4/" class="next">Next</a>
    
    <div class="center"><a href="/writings/blog/archives">Blog Archives</a></div>
</nav></div>
	<footer id="footer" class="inner">Copyright &copy; 2018

    Leonardo Borges

</footer>
	<script src="/writings/javascripts/slash.js"></script>
<script src="/writings/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->


<script type="text/javascript">
      var disqus_shortname = 'leonardoborges';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-2811271-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>



</body>
</html>